<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Comparable XAI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- Element UI CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>

  <!-- No internet open üëá-->
  <link rel="stylesheet" href="./index.css">
  <script src="./utils.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding-left: 30px;
    }

    table {
      /* width: 100%; */
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 14px;
      font-family: 'Roboto Condensed', monospace;
      color: #212121;


    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 6px;
      transition: max-width 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 200px;
      opacity: 1;
      overflow: hidden;
      white-space: nowrap;


    }

    th {
      font-size: 14px;
      font-family: sans-serif;
      /*background-color: #f0f8ff;*/
    }

    table,
    th,
    td {
      border: none;

    }



    .hidden {
      max-width: 0 !important;
      opacity: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      border-width: 0 !important;
      pointer-events: none;
    }

    .comp1,
    .comp2 {
      width: 40px;
      background-color: #fef6e4;
      transition: max-width 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .comp-header {
      font-size: 14px;

    }

    .highlight-blue {
      background-color: #e8f3fd;
    }

    .highlight-green2,
    .adj-price {
      background-color: #e4fcdc !important;
    }


    .highlight-green {
      background-color: #baf2a7 !important;
    }

    .adj-price {
      width: 62px;
      padding-right: 10px;
      border-right: 1px solid #36a341;
    }

    .green-right-border {
      border-right: 1px solid #36a341;
    }

    .adj-value {
      width: 42px;
      font-weight: 400;
      padding-right: 10px;
    }

    .adj-value-span {
      display: inline-block;
      width: 62px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }


    .comp-details,
    .adj-value {
      /* background-color: #f4fdf1; */
      background-color: #ffffff;

    }

    .highlight-yellow {
      background-color: #fef6e4;
    }

    .sub-header {
      background-color: #f0f0f0;
      font-weight: normal;
      font-size: 0.9em;
    }

    .clickable-header {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: bold;
      color: #0074d9;
      transition: color 0.2s;
    }

    .clickable-header:hover {
      color: #005fa3;
      text-decoration: underline;
    }

    .arrow {
      transition: transform 0.2s;
      display: inline-block;
    }

    .arrow.open {
      transform: rotate(180deg);
    }

    .toggle-text {
      width: 12px;
      line-height: 16px;
    }



    .adj-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .money {
      /* font-family: 'Roboto Mono', monospace; */
      font-family: 'Roboto Condensed', monospace;
      font-size: 14px;
      font-variant-numeric: tabular-nums;
      /* Á≠âÂÆΩÊï∞Â≠óÂØπÈΩê */
      letter-spacing: 0.5px;
      font-weight: 1200;
      color: #2e8113;

    }

    .adj-grey {
      color: #ccc;
      font-size: 1em;
      width: 30px;
      text-align: right;
    }


    .gray-bg {
      background-color: #ededed !important;
    }

    .adj-black {
      color: #222;
      font-weight: 500;
      font-size: 1em;
      width: 40px;
      text-align: left;
    }

    .plain-xai-table {
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
      min-width: 650px;
    }

    th {
      font-family: sans-serif;
    }

    .feature-name {
      font-size: 14px;
      text-align: left;
      font-weight: 400;
      width:192px;
      font-family: sans-serif;
    }

    .right-align {
      text-align: right;
    }

    .left-align {
      text-align: left;
    }

    .plain-xai-table {
      border: none;
    }

    .plain-xai-table th,
    .plain-xai-table td {

      padding: 6px 12px;

    }

    .plain-xai-table th {
      font-weight: bold;
    }

    .plain-xai-table tr td:first-child {

      font-weight: 500;
    }

    .gray-bg {
      background-color: #ededed !important;
      color: #ccc;
    }

    .gray-font {
      color: #ccc;
    }

    .nav-btn {
      background: #0074d9;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px 0 #0074d91a;
    }

    .nav-btn:disabled {
      background: #e5e7eb;
      color: #aaa;
      cursor: not-allowed;
      box-shadow: none;
    }

    .nav-btn:not(:disabled):hover {
      background: #005fa3;
      color: #fff;
    }

    .tab-content {}

    .border-btm {
      border-bottom: 1px solid #666;
    }

    .border-top {
      border-top: 1px solid #666;
    }

    .toggle-button {
      cursor: pointer;
      margin: 2px 0;
    }

    .toggle-button:hover {
      background: #cbf4be;
    }

    .subject {
      padding-right: 20px;
    }

    .detail-header-bg {
      background-attachment: #cbf4be !important;
    }

    .border-wider {
      border-top: 2px solid #a4a4a4;
    }

    .ai-pred-bg {
      /*background-color: #cbf4be;*/
      background-color: #ffffff;

    }

    .pred-description {
      color: #bd3030;
      padding: 2px 0 2px 0px;
      margin-top: 4px;
      display: inline-block;
      cursor: pointer;
    }

    /* Slider styles */
    .slider-container {
      margin-top: 15px;
      padding: 15px;
      border-radius: 6px;
      border: 1px dashed #222;
      max-width: 600px;
    }

    .slider-label {

      font-weight: 500;
      color: #495057;
      margin-bottom: 8px;
      display: block;
    }

    .slider-track {
      position: relative;
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      margin: 15px 0;
    }

    .slider-fill {
      position: absolute;
      height: 100%;
      background: #28a745;
      border-radius: 2px;
      top: 0;
    }

    .slider-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #fff;
      border: 2px solid #2e8113;
      border-radius: 50%;
      top: -6px;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }

    .slider-handle:hover {
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .slider-handle.active {
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
    }

    .slider-values {
      display: flex;
      justify-content: space-between;
      align-items: center;

      color: #6c757d;
      margin-top: 8px;
    }

    .disabled-input {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #2e8113;
      padding: 2px 6px;
      border-radius: 4px;

      font-family: 'Roboto Condensed', monospace;
      width: 50px;
      text-align: right;
      cursor: not-allowed;
    }

    .actual-price-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .pred-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .adjusted-price-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .all-pred-actual-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .tooltip-icon {
      cursor: pointer;
      margin-left: 2px;
      font-size: 10px;
      display: inline-block;
    }

    .trace-border-top {
      border-top: 4px solid #2874c1;
    }

    .trace-border-bottom {
      border-bottom: 4px solid #2874c1;
    }

    .trace-border-right {
      border-right: 4px solid #2874c1;
    }

    .trace-border-left {
      border-left: 4px solid #2874c1;
    }

    .annotation,
    .annotated {
      width: 26px;
      height: 26px;
      border-radius: 26px;
      text-align: center;
      line-height: 26px;
      color: #fff;
      box-shadow: 2px 2px 4px 0 #6b6b6b;
      font-weight: 600;
      font-family: sans-serif;
    }

    .annotation {
      background-color: #2874c1;
    }

    .annotated {
      background-color: #2874c1;
      opacity: 0.3;
    }

    .annotation-border-top {
      border-top: 2px solid #2874c1;
    }

    .annotation-border-btm {
      border-bottom: 2px solid #2874c1;
    }

    .annotation-border-left {
      border-left: 2px solid #2874c1;
    }

    .annotation-border-right {
      border-right: 2px solid #2874c1;

    }
  </style>
</head>

<body>

  <div id="app">
    <div class="tab-content" v-if="currentTutStep==0">

      <table class="plain-xai-table" style="border-collapse: separate; border-spacing: 4px 0;">
        <thead>
          <tr>
            <th></th>
            <th class="subject right-align" style="width: 62px;">
              <div style="margin: 0 auto;" class="annotation">2</div>
            </th>
          </tr>
          <tr>
            <th>
              <div style="margin: 0 auto;" class="annotation">1</div>
            </th>
            <th
              class="subject right-align border-btm annotation-border-top annotation-border-left annotation-border-right"
              style="width: 62px;">Subject</th>
          </tr>
        </thead>
        <tbody>
          <template v-for="(feature, index) in Features[domainIdx]">
            <tr>
              <td class="feature-name annotation-border-left annotation-border-right"
                :class="{'annotation-border-top':index==0, 'annotation-border-btm':index==Features[domainIdx].length-1}">
                {{feature}}
                <el-tooltip :content="FeatureDescriptions[domainIdx][index]" placement="right" effect="dark"
                  :show-after="0">
                  <span class="tooltip-icon" style="cursor: pointer; margin-left: 4px;">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </td>
              <td class="right-align annotation-border-left annotation-border-right" style="cursor:pointer"
                :class="{'annotation-border-btm':index==Features[domainIdx].length-1}">
                <el-tooltip :content="Targets[domainIdx]?.[currentTargetIndex].feature_val[index]" placement="right"
                  effect="dark" :show-after="0">
                 
                  <el-tooltip :content="Targets[domainIdx]?.[currentTargetIndex].feature_val[index]" placement="right" effect="dark"
                  :show-after="0">
                <span style="width: 90px;
                cursor:pointer;
                overflow: hidden;
                text-overflow: ellipsis;
                display: inline-block;">
                  {{Targets[domainIdx]?.[currentTargetIndex].feature_val[index]}}
                </span></el-tooltip>
              </td>
              </el-tooltip>

            </tr>
          </template>
          <tr>
            <td colspan="2" style="padding: 0; overflow: visible;">
              <!-- sub tabel -->
              <table class="highlight-green"
                style="overflow: visible; width: 100%; border-collapse: collapse; margin:0;">
                <tr style="overflow: visible;">

                  <td style="width: 140px; position: relative; overflow: visible;"
                    class="feature-name money highlight-green">
                    <div style="margin: 0 auto; position: absolute; top: 0; left: -30px;" class="annotation">3</div>
                    {{ Labels[domainIdx][0] }}
                    <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark"
                      :show-after="0" trigger="hover" :hide-after="0">
                      <span class="tooltip-icon">
                        <i class="fa-regular fa-circle-question"></i>
                      </span>
                    </el-tooltip>
                  </td>
                  <td class="right-align money highlight-green" style="cursor: pointer;">
                    <el-tooltip content="To Be Determined" placement="right" effect="dark" :show-after="0"
                      trigger="hover" :hide-after="0">
                      TBD
                    </el-tooltip>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <tr>
            <td style="height:4px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>
              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">
              </td>
            </template>
          </tr>

          <tr>
            <td style="width: 140px; position:relative; overflow:visible;" class="feature-name money">
              <div style="margin: 0 auto; 
              position:absolute; top:0; left:-30px;" class="annotation">4</div>
              {{Labels[domainIdx][1]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align money">{{Targets[domainIdx]?.[currentTargetIndex]?.pred}}{{unit_list[domainIdx]}}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- STAET COMPAEABLE TUT-->
    <div class="tab-content" v-if="currentTutStep==1">
      <table class="plain-xai-table" style="border-collapse: separate; border-spacing: 4px 0;">
        <thead>
          <tr>
            <th></th>
            <th class="subject right-align" style="width: 62px;">
              <div style="margin: 0 auto;" class="annotation">2</div>
            </th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 62px;" class="right-align">
                <div style="margin: 0 auto;" class="annotation">5</div>
              </th>
            </template>

          </tr>

          <tr>
            <th>
              <div style="margin: 0 auto;" class="annotation">1</div>
            </th>
            <th class="subject right-align border-btm" style="width: 62px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 62px;"
                class="right-align border-btm annotation-border-top annotation-border-left annotation-border-right">
                Comparable {{idx+1}}</th>
            </template>

          </tr>

        </thead>
        <tbody>
          <template v-for="(feature, index) in Features[domainIdx]">
            <tr>
              <td class="feature-name" style="width:320px;">
                {{feature}}
                <el-tooltip :content="FeatureDescriptions[domainIdx][index]" placement="right" effect="dark"
                  :show-after="0">
                  <span class="tooltip-icon" style="cursor: pointer; margin-left: 4px;">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </td>
              <td class="right-align">
                <el-tooltip :content="Targets[domainIdx]?.[currentTargetIndex].feature_val[index]" placement="right" effect="dark"
                  :show-after="0">
                <span style="width: 90px;
                cursor:pointer;
                overflow: hidden;
                text-overflow: ellipsis;
                display: inline-block;">
                  {{Targets[domainIdx]?.[currentTargetIndex].feature_val[index]}}
                </span></el-tooltip>
                </td>
              <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
                <td class="right-align annotation-border-left annotation-border-right"
                  :class="{'annotation-border-btm': index == Features[domainIdx].length -1 }" :style="{ color: row.feature_val[index] ==
                Targets[domainIdx]?.[currentTargetIndex].feature_val[index] ? '#ccc' : '#222' }">
                <el-tooltip :content="row.feature_val[index]" placement="right" effect="dark"
                :show-after="0">
                <span style="width: 90px;
                cursor:pointer;
                overflow: hidden;
                text-overflow: ellipsis;
                display: inline-block;">{{row.feature_val[index]}}</span></el-tooltip>
                </td>
              </template>
            </tr>

          </template>

          <tr>
            <td :colspan="2 + Comparables[domainIdx][currentTargetIndex].length" style="padding: 0; overflow:visible;">
              <table class="highlight-green"
                style="width: 100%; border-collapse: collapse; margin:0; overflow:visible;">
                <tr style="overflow:visible;">
                  <!-- Â∑¶‰æßÊ†áÁ≠æ -->
                  <td style="width: 280px; position:relative; overflow:visible;"
                    class="feature-name money highlight-green">
                    <div style="margin: 0 auto; 
              position:absolute; top:0; left:-30px;" class="annotation">3</div>
                    {{Labels[domainIdx][0]}}
                    <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark"
                      :show-after="0" trigger="hover" :hide-after="0">
                      <span class="tooltip-icon">
                        <i class="fa-regular fa-circle-question"></i>
                      </span>
                    </el-tooltip>
                  </td>

                  <!-- Subject ÂÄº -->
                  <td class="right-align money highlight-green"
                    style="width:90px; cursor: pointer; border:2px solid #2874c1; overflow:visible; position:relative;">
                    <div class="annotation" style="position: absolute; top: 0; left: 0px;">3a</div>
                    <div style="cursor: pointer;">
                      <el-tooltip placement="top" effect="light" :show-after="0" trigger="hover" :hide-after="0">
                        <template #content>
                          Estimated value based on {{Comparables[domainIdx]?.[currentTargetIndex]?.length}}
                          Comparable{{Comparables[domainIdx]?.[currentTargetIndex]?.length>1?'s':''}}:<br />
                          {{weightedAverageTooltipContentForComparable}}<br />

                          <span style="width:60px;color:#bd3030; font-size:12px; font-weight:400; line-height:12px;">
                            <!-- {{warningContent}} -->
                            <span style="font-weight: 800;">Warning: </span> this is an estimate so it may be
                            inaccurate.
                          </span>

                        </template>
                        <div>
                          {{weightedAverageValueForComparable}}
                          <div class="approx-warning">
                            ‚âà
                          </div>
                        </div>

                      </el-tooltip>
                  </td>

                  <!-- Comparable ÂÄº -->
                  <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
                    <td class="right-align money highlight-green">
                      {{row.actual}}{{unit_list[domainIdx]}}
                    </td>
                  </template>
                </tr>
              </table>
            </td>
          </tr>

          <tr>
            <td class="feature-name" style="position: relative; overflow:visible;">
              <div style="margin: 0 auto; 
              position:absolute; top:0; left:-30px;" class="annotation">6</div>
              Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">‚Äî</td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align" :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}"
                style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>

            </template>
          </tr>

          <tr>
            <td style="height:2px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">

              </td>
            </template>
          </tr>

          <tr>
            <td style="width: 140px; position:relative; overflow:visible;" class="feature-name money">
              <div style="margin: 0 auto; 
              position:absolute; top:0; left:-30px;" class="annotation">4</div>

              <div style="margin: 0 auto; 
              position:absolute; bottom:0; left:-30px;" class="annotation">4a</div>

              {{Labels[domainIdx][1]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <!-- <i class="fa-regular fa-circle-question"></i> -->
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </span>
            </td>

            <td class="right-align money">{{Targets[domainIdx]?.[currentTargetIndex]?.pred}}{{unit_list[domainIdx]}}
              <br> <span>‚Äî</span>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td class="right-align money">{{row.pred}}{{unit_list[domainIdx]}}
                <br />
                <el-tooltip
                  :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                  placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                    @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                </el-tooltip>
              </td>
            </template>

          </tr>

        </tbody>
      </table>
    </div>

    <div class="tab-content" v-if="currentTutStep=='lr'">
      <div style="position: absolute;  padding:0 10px; width:400px; top:400px; line-height:18px;">
        <div style="margin: 0 auto;" class="annotation">3a</div>
        <div
          style="padding:10px; margin-top:10px; width:400px; line-height:18px; border:2px solid #005fa3;">
          <!-- 1. ÊèèËø∞ÊñáÂ≠ó -->

          <div style="font-size:12px; font-weight:500; margin:10px 0;">

            Based on the Linear Regression model trained on {{Comparables[domainIdx]?.[currentTargetIndex]?.length}} comparables, 
                    the factors for each attribute are:
            <br />
            Positive means a positive influence, and a larger absolute value means greater importance.
            <br/>
            <span style="width:60px;color:#bd3030; font-size:12px; font-weight:400; line-height:12px;">
              <!-- {{warningContent}} -->
              <span style="font-weight: 800;">Warning: </span> this is an estimate so it may be inaccurate.
            </span>
          </div>
          <div style="display: flex;">
            <!-- 2. Á≥ªÊï∞Ë°®Ê†º -->
            <table style="border-collapse: collapse; font-size: 12px; width:100%; margin-left:30px;">
              <thead>
                <tr>
                  <th style="padding:2px 0px; font-size: 12px; text-align:left;">Attribute</th>
                  <th style="padding:2px 0px; font-size: 12px; text-align:right;">Value</th>
                  <th style="padding:2px 0px; font-size: 12px; text-align:right;">Factors</th>
                  <th style="width:80px;padding:2px 0px; font-size: 12px; text-align:right; color:#2e8113">Partial
                    ({{unit_list_header[domainIdx]}})</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(row,i) in getLinearTooltipRows(domainIdx, currentTargetIndex)" :key="i" :style="{ color: row.factor ==
            0 ? '#ddd' : '#222' }">
                  <td style="padding:0; height:16px;"><span
                      style="overflow: hidden; display:inline-block;width:100px; text-overflow:ellipsis;">{{
                      row.name }}</span></td>
                  <td style="padding:0; text-align:right;">{{ row.value }}</td>
                  <td style="padding:0 4px;text-align:right;">√ó <span style="display:inline-block; width: 40px;">{{
                      row.factor ==0? '': row.factor }} </span>
                  </td>
                  <td style="padding:0 4px;text-align:right;">= <span
                      style="display:inline-block; width: 40px; color:#2e8113"> {{ row.partial==0?'':row.partial
                      }}{{row.partial==0?'':unit_list[domainIdx]}}</span></td>
                </tr>

                <tr style="font-weight:bold; color:#222; color:#2e8113">
                  <td colspan="3" style="padding:0px;">Adjustment ({{unit_list_header[domainIdx]}})</td>

                  <td style="padding:0px 4px; text-align:right;">= <span style="display:inline-block; width: 40px;">
                      {{
                      Linear_reg[domainIdx][currentTargetIndex].intercept.toFixed(1) }}{{unit_list[domainIdx]}}
                    </span></td>
                </tr>

              </tbody>
            </table>
            <!-- 3. Âä†Âè∑‰∏éÁÆ≠Â§¥ÊåáÂêë AI Explainer -->
            <div style="display:flex; align-items:center;">
              <div style=" font-size:20px; margin-top:-4px; margin-left:10px; color:#2e8113"> } </div>
              <div style="font-size:20px; margin-left:8px; color:#2e8113">+</div>
              <div style="margin:0 8px; margin-top:-2px;font-size:14px; color:#2e8113">‚Üí</div>
              <div style="width:60px; font-size:14px; color:#2e8113;">
                {{unit_list_header[domainIdx]}}{{
                Linear_reg[domainIdx][currentTargetIndex].linear_pred.toFixed(1) }}{{
                unit_list[domainIdx] }}
                <br />
              </div>

            </div>
          </div>
        </div>
      </div>

      <table class="plain-xai-table" style="border-collapse: separate; border-spacing: 4px 0;">
        <thead>
          <tr>
            <th></th>
            <th class="subject right-align" style="width: 62px;">
              <div style="margin: 0 auto;" class="annotation">2</div>
            </th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 62px;" class="right-align">
                <div style="margin: 0 auto;" class="annotation">5</div>
              </th>
            </template>

          </tr>

          <tr>
            <th>
              <div style="margin: 0 auto;" class="annotation">1</div>
            </th>
            <th class="subject right-align border-btm" style="width: 62px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 62px;"
                class="right-align border-btm annotation-border-top annotation-border-left annotation-border-right">
                Comparable {{idx+1}}</th>
            </template>

          </tr>

        </thead>
        <tbody>
          <template v-for="(feature, index) in Features[domainIdx]">
            <tr>
              <td class="feature-name">
                {{feature}}
                <el-tooltip :content="FeatureDescriptions[domainIdx][index]" placement="right" effect="dark"
                  :show-after="0">
                  <span class="tooltip-icon" style="cursor: pointer; margin-left: 4px;">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </td>
              <td class="right-align">{{Targets[domainIdx]?.[currentTargetIndex].feature_val[index]}}</td>
              <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
                <td class="right-align annotation-border-left annotation-border-right"
                  :class="{'annotation-border-btm': index == Features[domainIdx].length -1 }" :style="{ color: row.feature_val[index] ==
                Targets[domainIdx]?.[currentTargetIndex].feature_val[index] ? '#ccc' : '#222' }">
                  {{row.feature_val[index]}}
                </td>
              </template>
            </tr>

          </template>

          <tr>
            <td :colspan="2 + Comparables[domainIdx][currentTargetIndex].length" style="padding: 0; overflow:visible;">
              <table class="highlight-green"
                style="width: 100%; border-collapse: collapse; margin:0; overflow:visible;">
                <tr style="overflow:visible;">
                  <!-- Â∑¶‰æßÊ†áÁ≠æ -->
                  <td style="width: 180px; position:relative; overflow:visible;"
                    class="feature-name money highlight-green">
                    <div style="margin: 0 auto; 
              position:absolute; top:0; left:-30px;" class="annotation">3</div>
                    {{Labels[domainIdx][0]}}
                    <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark"
                      :show-after="0" trigger="hover" :hide-after="0">
                      <span class="tooltip-icon">
                        <i class="fa-regular fa-circle-question"></i>
                      </span>
                    </el-tooltip>
                  </td>

                  <!-- Subject ÂÄº -->
                  <td class="right-align money highlight-green"
                    style="cursor: pointer; width:88px; position:relative; border:2px solid #2874c1; overflow:visible; position:relative;">
                    <div class="annotation" style="position: absolute; top:0; left:0px;">3a</div>

                    <el-tooltip placement="right" effect="light" :show-after="0" :visible="True">
                      <template #content>
                        <!-- 1. ÊèèËø∞ÊñáÂ≠ó -->
                        <div style="font-size:12px; font-weight:500; margin:10px 0;">

                          Based on Comparables, the adjustment factors for each attribute are:
                          <br />
                          <span style="width:60px;color:#bd3030; font-size:12px; font-weight:400; line-height:12px;">
                            <!-- {{warningContent}} -->
                            <span style="font-weight: 800;">Warning: </span> this is an estimate so it may be
                            inaccurate.
                          </span>
                        </div>
                        <div style="display: flex;">
                          <!-- 2. Á≥ªÊï∞Ë°®Ê†º -->
                          <table style="border-collapse: collapse; font-size: 12px; width:100%; margin-left:30px;">
                            <thead>
                              <tr>
                                <th style="padding:2px 0px; font-size: 12px; text-align:left;">Attribute</th>
                                <th style="padding:2px 0px; font-size: 12px; text-align:right;">Value</th>
                                <th style="padding:2px 0px; font-size: 12px; text-align:right;">Factors</th>
                                <th
                                  style="width:80px;padding:2px 0px; font-size: 12px; text-align:right; color:#2e8113">
                                  Partial ({{unit_list_header[domainIdx]}})</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr v-for="(row,i) in getLinearTooltipRows(domainIdx, currentTargetIndex)" :key="i"
                                :style="{ color: row.factor ==
                              0 ? '#ddd' : '#222' }">
                                <td style="padding:0; height:16px;"><span
                                    style="overflow: hidden; display:inline-block;width:100px; text-overflow:ellipsis;">{{
                                    row.name }}</span></td>
                                <td style="padding:0; text-align:right;">{{ row.value }}</td>
                                <td style="padding:0 4px;text-align:right;">√ó <span
                                    style="display:inline-block; width: 40px;">{{ row.factor ==0? '': row.factor }}
                                  </span>
                                </td>
                                <td style="padding:0 4px;text-align:right;">= <span
                                    style="display:inline-block; width: 40px; color:#2e8113"> {{
                                    row.partial==0?'':row.partial }}{{row.partial==0?'':unit_list[domainIdx]}}</span>
                                </td>
                              </tr>

                              <tr style="font-weight:bold; color:#222; color:#2e8113">
                                <td colspan="3" style="padding:0px;">Adjustment ({{unit_list_header[domainIdx]}})
                                </td>

                                <td style="padding:0px 4px; text-align:right;">= <span
                                    style="display:inline-block; width: 40px;">
                                    {{
                                    Linear_reg[domainIdx][currentTargetIndex].intercept.toFixed(1)
                                    }}{{unit_list[domainIdx]}}
                                  </span></td>
                              </tr>

                            </tbody>
                          </table>
                          <!-- 3. Âä†Âè∑‰∏éÁÆ≠Â§¥ÊåáÂêë AI Explainer -->
                          <div style="display:flex; align-items:center;">
                            <div style=" font-size:20px; margin-top:-4px; margin-left:10px; color:#2e8113"> } </div>
                            <div style="font-size:20px; margin-left:8px; color:#2e8113">+</div>
                            <div style="margin:0 8px; margin-top:-2px;font-size:14px; color:#2e8113">‚Üí</div>
                            <div style="width:60px; font-size:14px; color:#2e8113;">
                              {{unit_list_header[domainIdx]}}{{
                              Linear_reg[domainIdx][currentTargetIndex].linear_pred.toFixed(1) }}{{
                              unit_list[domainIdx] }}
                              <br />
                            </div>

                          </div>
                        </div>

                      </template>
                      <span class="right-align money highlight-green" style="cursor: pointer; font-weight:500;">
                        {{ Linear_reg[domainIdx]?.[currentTargetIndex]?.linear_pred.toFixed(1) }}{{
                        unit_list[domainIdx] }}
                        <div class="approx-warning">
                          <!-- <i class="fa-solid fa-exclamation"></i> -->
                          ‚âà
                          <!-- <i class="fa-solid fa-circle-exclamation"></i> -->
                        </div>
                      </span>
                    </el-tooltip>
                  </td>

                  <!-- Comparable ÂÄº -->
                  <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
                    <td class="right-align money highlight-green">
                      {{row.actual}}{{unit_list[domainIdx]}}
                    </td>
                  </template>
                </tr>
              </table>
            </td>
          </tr>

          <tr>
            <td class="feature-name" style="position: relative; overflow:visible;">
              <div style="margin: 0 auto; 
              position:absolute; top:0; left:-30px;" class="annotation">6</div>
              Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">‚Äî</td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align" :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}"
                style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>

            </template>
          </tr>

          <tr>
            <td style="height:2px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">

              </td>
            </template>
          </tr>

          <tr>
            <td style="width: 140px; position:relative; overflow:visible;" class="feature-name money">
              <div style="margin: 0 auto; 
              position:absolute; top:0; left:-30px;" class="annotation">4</div>

              <div style="margin: 0 auto; 
              position:absolute; bottom:0; left:-30px;" class="annotation">4a</div>

              {{Labels[domainIdx][1]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <!-- <i class="fa-regular fa-circle-question"></i> -->
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </span>
            </td>

            <td class="right-align money">{{Targets[domainIdx]?.[currentTargetIndex]?.pred}}{{unit_list[domainIdx]}}
              <br> <span>‚Äî</span>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td class="right-align money">{{row.pred}}{{unit_list[domainIdx]}}
                <br />
                <el-tooltip
                  :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                  placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                    @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                </el-tooltip>
              </td>
            </template>

          </tr>

        </tbody>
      </table>
    </div>

    <!-- STAET COMPAEABLE WITH ADJUSTMENTS TUT-->
    <div class="tab-content" v-if="currentTutStep ==2 ">
      <table>
        <thead>
          <!-- <tr>
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header right-align subject" style="width: 50px;"></th>
            <template v-for="(row, idx) in Comparables[domain][currentTargetIndex]" :key="row.id" class="comp1-header"
              style="position:relative;">
              <th colspan="2" class="comp1-header right-align" style="position:relative;">
              </th>

              <th :colspan="row.adjusted_step_number * 2" class="comp-details border-btm"
                style="padding-right: 10px; text-align: center;" colspan="2" :class="{hidden: currentOpenComp!==idx}">
                Comparable {{idx + 1}} Adjustment Trace</th>


            </template>
          </tr> -->
          <!-- Header row -->
          <tr style="border-top:2px solid transparent">
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header subject" style="width: 50px;">
              <div style="margin-left:20px;" class="annotated">2</div>
            </th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id"
              class="comp1-header" style="position:relative;">
              <th colspan="2" class="comp1-header right-align border-btm" style="position:relative;">

                <div style="margin-left:50px;" class="annotated">5</div>

                <!-- <div style="font-size: 12px; display:flex;align-items:center;justify-content:center;color:#800080">
                  AI Prediction ($): {{row.pred}}K
                </div> -->

              </th>



              <th class="border-btm comp-details" :colspan="row.adjusted_step_number * 2"
                :class="{hidden: currentOpenComp!==idx}">
                <div style="margin:0 auto" class="annotation">8</div>
              </th>
            </template>
          </tr>
          <tr style="border-top:2px solid transparent">
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header right-align subject" style="width: 50px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id"
              class="comp1-header" style="position:relative;">
              <th colspan="2" class="comp1-header right-align border-btm"
                :class="{'trace-border-left': currentOpenComp===idx, 'trace-border-top': currentOpenComp===idx, 'green-right-border': currentOpenComp===idx}"
                style="position:relative;">

                Comparable {{idx + 1}}

                <!-- <div style="font-size: 12px; display:flex;align-items:center;justify-content:center;color:#800080">
                  AI Prediction ($): {{row.pred}}K
                </div> -->
                <el-tooltip v-if="currentTutStep==3" :content="currentOpenComp==idx ? 'Hide Trace' : 'Show Trace'"
                  placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <button class="toggle-button" @click="toggleCols(`comp${idx+1}`,idx)">

                    <span v-if="currentOpenComp!=idx" class="toggle-text">{{ currentOpenComp ==idx ? ' ' : '...'
                      }}</span>

                    <i class="toggle-text fa-solid fa-angle-left" v-if="currentOpenComp==idx"></i>

                  </button>
                </el-tooltip>
              </th>

              <!-- <th class="border-btm comp-details" :colspan="row.adjusted_step_number * 2"
              :class="{hidden: currentOpenComp!==idx}">
              Comparable {{idx + 1}} Adjustment Trace
              </th> -->
              <template v-for="i in row.adjusted_step_number">
                <th class="border-btm comp-details trace-border-top green-right-border" style="" colspan="2" :class="{hidden: currentOpenComp!==idx, 
                  'trace-border-right': i === row.adjusted_price.length}">
                  {{ i === row.adjusted_price.length ? '‚âà Subject' : i }}</th>
              </template>

              <!-- <th class="border-btm comp-details" :colspan="row.adjusted_step_number * 2"
                :class="{hidden: currentOpenComp!==idx}">
                Comparable {{idx + 1}} Adjustment Trace
              </th> -->
            </template>
          </tr>
          <!-- AI prediction row -->
          <!-- <tr>
            <td class="feature-name money">AI Prediction ($)</td>
            <td class="right-align money subject">{{Targets[currentTargetIndex].pred}}K </td>
            <template v-for="(row, idx) in Comparables[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>
                  {{row.pred}}K
              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align comp-details"
                :class="{hidden: currentOpenComp!==idx}"> 
              </td>
            </template>
          </tr> -->
          <!-- header -->

          <tr>
            <td class="comp1-header">
              <div style="margin-left:50px;" class="annotated">1</div>
            </td>
            <td class="subject"></td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 64px; position:relative; overflow:visible;"
                class="comp-header right-align border-btm annotation-border-left annotation-border-right annotation-border-top"
                :class="{'trace-border-left': currentOpenComp===idx}">
                <div class="annotation" style="position: absolute; top:4px; left:-2px;">5a</div> Values
              </th>
              <th :class="{'adj-price' : currentOpenComp===idx }"
                class="comp1-header right-align border-btm money highlight-green2 annotation-border-left annotation-border-right annotation-border-top"
                style="width: 62px;position:relative;">
                <div class="annotation" style="position: absolute; top:4px;">5b</div>
                <span> {{unit_list_header[domainIdx]}} Œî </span>

              </th>
              <template v-for="i in row.adjusted_step_number">
                <th class="adj-value border-btm right-align" style="font-weight: bold;"
                  :class="{hidden: currentOpenComp!==idx}">Values</th>
                <th class="adj-price border-btm right-align money" style="font-weight: bold;" :class="{hidden: currentOpenComp!==idx, 
                  'trace-border-right': i === row.adjusted_price.length}">
                  {{unit_list_header[domainIdx]}} Œî
                </th>
              </template>
            </template>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(tb, index) in Features[domainIdx]">
            <td class="feature-name">
              <span>{{ Features[domainIdx][index] }}</span>
              <el-tooltip :content="FeatureDescriptions[domainIdx][index]" placement="right" effect="dark"
                :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">
              <el-tooltip :content="Targets[domainIdx]?.[currentTargetIndex].feature_val[index]" placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <div style=" display: inline-block;
                max-width: 62px;
                width: 62px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                vertical-align: top; cursor: pointer;">
                  {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] }}

                </div>
              </el-tooltip>
              <!-- <template v-else>
                <div style="cursor: default;">
                  {{ Targets[domain][currentTargetIndex].feature_val[index] }}
                </div>
              </template> -->

            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align annotation-border-left annotation-border-right"
                :class="{'gray-font': row.delta_y[index]==0, 'trace-border-left': currentOpenComp===idx, 'annotation-border-btm':index == Features[domainIdx].length-1}">
                <el-tooltip :content="row.feature_val[index]" placement="right" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  <div style=" display: inline-block;
                  max-width: 62px;
                  width: 62px;
                  overflow: hidden;
                  white-space: nowrap;
                  text-overflow: ellipsis;
                  vertical-align: top; cursor: pointer;">
                    {{ row.feature_val[index] }}

                  </div>
                </el-tooltip>
                <!-- <template v-else>
                  <div style="cursor: default;">{{ row.feature_val[index] }} </div>
                </template> -->
              </td>
              <td style="cursor: pointer;"
                class="comp1-header right-align money highlight-green2 annotation-border-left annotation-border-right"
                :class="{'gray-font': row.delta_y[index]==0, 'adj-price' : currentOpenComp==idx,'annotation-border-btm':index == Features[domainIdx].length-1 }">
                <el-tooltip :content="getDeltayTooltip(row,index)" placement="top" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  {{row.delta_y[index]!==0? row.delta_y[index]+unit_list[domainIdx]:'0' }}
                </el-tooltip>
              </td>
              <template v-for="i in row.adjusted_step_number">
                <td class="right-align adj-value" :class="{hidden: currentOpenComp!==idx }"
                  :style="{ color: index == row.adjusted_order[i-1] ? '#222' : '#bcbcbc', cursor: index == row.adjusted_order[i-1] ? 'pointer' : 'default' }">
                  <!-- <span v-if="row.adjusted_order.slice(0,i).includes(index)"  style="cursor: pointer;"> -->
                  <span class="adj-value-span">

                    <!-- {{ row.feature_val[index] }} -->
                    <!-- <i class="fa-solid fa-arrow-right" style="font-size:10px;vertical-align:middle;"></i> -->
                    <el-tooltip v-if="index == row.adjusted_order[i-1]" :content="numberical_feature[domainIdx][index] ? 
                        row.feature_val[index]+' ‚Üí '+Targets[domainIdx]?.[currentTargetIndex].feature_val[index]+' (Œî: '+(row.delta_x[index] >= 0 ? '+' : '')+row.delta_x[index]+')' :
                        row.feature_val[index]+' ‚Üí '+Targets[domainIdx]?.[currentTargetIndex].feature_val[index]"
                      placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                      {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] }}
                    </el-tooltip>
                    <template v-else-if="row.adjusted_order.slice(0,i).includes(index)">
                      {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] }}
                    </template>
                    <template v-else>
                      {{Comparables[domainIdx]?.[currentTargetIndex][idx].feature_val[index]}}
                    </template>

                  </span>
                  <!-- <span v-else>
                    ‚Äî
                  </span> -->
                </td>
                <td class="right-align adj-price money"
                  :class="{hidden: currentOpenComp!==idx, 'trace-border-right': i === row.adjusted_price.length}"
                  :style="{ color: index ==
                 row.adjusted_order[i-1] ? '#2e8113' : '#bcbcbc' }">{{
                  row.adjusted_order.slice(0,i).includes(index)? row.delta_y[index]+unit_list[domainIdx] : ''}}</td>
              </template>
            </template>
          </tr>

          <tr class="">

            <td class="feature-name money highlight-green" style="position: relative; overflow:visible;">
              <div style="position: absolute; top:0; left:-30px;" class="annotated">3</div>
              {{Labels[domainIdx][0]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark" :show-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject money highlight-green" @mouseenter="highlightAllAdjustedPrices()"
              @mouseleave="unhighlightAllAdjustedPrices()"
              style="border:2px solid #2874c1; overflow:visible; position:relative;">
              <div class="annotation" style="position: absolute; top: 0; left: -20px;">3a</div>
              <div style="cursor: pointer;">

                <el-tooltip :content="weightedAverageTooltipContent" placement="top" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  <span style="cursor: pointer;">
                    {{weightedAverageValue}}{{unit_list[domainIdx]}}
                  </span>
                </el-tooltip>
                <el-tooltip :content="warningContent" placement="top" effect="dark" :show-after="0" trigger="hover"
                  :hide-after="0">
                  <span class="approx-warning">
                    <!-- <i class="fa-solid fa-exclamation"></i> -->
                    ‚âà
                    <!-- <i class="fa-solid fa-circle-exclamation"></i> -->
                  </span>
                </el-tooltip>

                </span>
              </div>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money highlight-green"
                style="border-left:2px solid #bbf2a7; border-right:2px solid #bbf2a7;"
                :class="{ 'actual-price-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted, 'trace-border-left': currentOpenComp===idx }">
                <span>
                  {{row.actual}}{{unit_list[domainIdx]}}
              </td>
              <td :colspan="row.adjusted_step_number*2"
                class="right-align money comp-details highlight-green trace-border-right"
                :class="{hidden: currentOpenComp!==idx}" style="position:relative;">
                <!-- {{row.actual}}{{unit_list[domainIdx]}} -->
              </td>

            </template>
          </tr>
          <tr>
            <td class="feature-name money border-top highlight-green2 " style="position: relative; overflow:visible;">
              <div style="position: absolute; top:0; left:-30px;" class="annotation">7</div>
              {{Labels[domainIdx][2]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][2]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align money subject highlight-green2 border-top">‚Äî</td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money border-top highlight-green2"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted, 'trace-border-bottom': currentOpenComp===idx, 'trace-border-left': currentOpenComp===idx}"
                style="position:relative; border-left:2px solid #e4fcdc; border-right:2px solid #e4fcdc;">
                <span>{{row.adjusted_price[row.adjusted_step_number - 1]}}{{unit_list[domainIdx]}}
              </td>
              <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align money comp-details border-top highlight-green2 trace-border-bottom"
                  :class="{hidden: currentOpenComp!==idx, 'trace-border-right': i === row.adjusted_price.length - 1}"
                  style="position:relative;">
                  <span>{{ele}}{{unit_list[domainIdx]}}</span>
                </td>
              </template>
            </template>
          </tr>
          <!--  Reconsolidation -->

          <tr>
            <td class="feature-name" style="position: relative; overflow:visible;">
              <div style="position: absolute; top:0; left:-30px;" class="annotated">6</div>
              Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">‚Äî</td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}" style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>
              <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align comp-details" :class="{hidden: currentOpenComp!==idx}"
                  style="position:relative;">
                  <span></span>
                </td>
              </template>
            </template>
          </tr>
          <tr>
            <td style="height:20px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">

              </td>
            </template>
          </tr>

          <tr>
            <td class="feature-name money ai-pred-bg" style="position: relative; overflow:visible">
              <div style="position: absolute; top:0; left:-30px;" class="annotated">4</div>
              <div style="position: absolute; bottom:0; left:-30px;" class="annotated">4a</div>
              {{Labels[domainIdx][1]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>

              </span>
            </td>
            <td class="right-align money subject ai-pred-bg">
              {{Targets[domainIdx]?.[currentTargetIndex]?.pred}}{{unit_list[domainIdx]}} <br />
              <span class="pred-description"> ‚Äî </span>
            </td>

            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money ai-pred-bg"
                :class="{ 'pred-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted }">
                <span>
                  {{row.pred}}{{unit_list[domainIdx]}}
                  <br />
                  <el-tooltip
                    :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                    placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                    <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                      @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                  </el-tooltip>
              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align ai-pred-bg"
                :class="{hidden: currentOpenComp!==idx}">
                <!-- {{row.pred}}K -->
              </td>
            </template>
          </tr>
        </tbody>
      </table>

    </div>
    <div class="tab-content" v-if="currentTutStep ==3 ">
      <table>
        <thead>
          <!-- <tr>
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header right-align subject" style="width: 50px;"></th>
            <template v-for="(row, idx) in Comparables[domain][currentTargetIndex]" :key="row.id" class="comp1-header"
              style="position:relative;">
              <th colspan="2" class="comp1-header right-align" style="position:relative;">
              </th>

              <th :colspan="row.adjusted_step_number * 2" class="comp-details border-btm"
                style="padding-right: 10px; text-align: center;" colspan="2" :class="{hidden: currentOpenComp!==idx}">
                Comparable {{idx + 1}} Adjustment Trace</th>


            </template>
          </tr> -->
          <!-- Header row -->
          <tr style="border-top:2px solid transparent">
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header subject" style="width: 50px;">
              <div style="margin-left:20px;" class="annotated">2</div>
            </th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id"
              class="comp1-header" style="position:relative;">
              <th colspan="2" class="comp1-header right-align border-btm" style="position:relative;">

                <div style="margin-left:50px;" class="annotated">5</div>

                <!-- <div style="font-size: 12px; display:flex;align-items:center;justify-content:center;color:#800080">
                  AI Prediction ($): {{row.pred}}K
                </div> -->

              </th>



              <th class="border-btm comp-details" :colspan="row.adjusted_step_number * 2"
                :class="{hidden: currentOpenComp!==idx}">
                <div style="margin:0 auto" class="annotation">8</div>
              </th>
            </template>
          </tr>
          <tr style="border-top:2px solid transparent">
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header right-align subject" style="width: 50px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id"
              class="comp1-header" style="position:relative;">
              <th colspan="2" class="comp1-header right-align border-btm"
                :class="{'trace-border-left': currentOpenComp===idx, 'trace-border-top': currentOpenComp===idx, 'green-right-border': currentOpenComp===idx}"
                style="position:relative;">

                Comparable {{idx + 1}}

                <!-- <div style="font-size: 12px; display:flex;align-items:center;justify-content:center;color:#800080">
                  AI Prediction ($): {{row.pred}}K
                </div> -->
                <el-tooltip v-if="currentTutStep==3" :content="currentOpenComp==idx ? 'Hide Trace' : 'Show Trace'"
                  placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <button class="toggle-button" @click="toggleCols(`comp${idx+1}`,idx)">

                    <span v-if="currentOpenComp!=idx" class="toggle-text">{{ currentOpenComp ==idx ? ' ' : '...'
                      }}</span>

                    <i class="toggle-text fa-solid fa-angle-left" v-if="currentOpenComp==idx"></i>

                  </button>
                </el-tooltip>
              </th>

              <!-- <th class="border-btm comp-details" :colspan="row.adjusted_step_number * 2"
              :class="{hidden: currentOpenComp!==idx}">
              Comparable {{idx + 1}} Adjustment Trace
              </th> -->
              <template v-for="i in row.adjusted_step_number">
                <th class="border-btm comp-details trace-border-top green-right-border" style="" colspan="2" :class="{hidden: currentOpenComp!==idx, 
                  'trace-border-right': i === row.adjusted_price.length}">
                  {{ i === row.adjusted_price.length ? '‚âà Subject' : i }}</th>
              </template>

              <!-- <th class="border-btm comp-details" :colspan="row.adjusted_step_number * 2"
                :class="{hidden: currentOpenComp!==idx}">
                Comparable {{idx + 1}} Adjustment Trace
              </th> -->
            </template>
          </tr>
          <!-- AI prediction row -->
          <!-- <tr>
            <td class="feature-name money">AI Prediction ($)</td>
            <td class="right-align money subject">{{Targets[currentTargetIndex].pred}}K </td>
            <template v-for="(row, idx) in Comparables[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>
                  {{row.pred}}K
              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align comp-details"
                :class="{hidden: currentOpenComp!==idx}"> 
              </td>
            </template>
          </tr> -->
          <!-- header -->

          <tr>
            <td class="comp1-header">
              <div style="margin-left:50px;" class="annotated">1</div>
            </td>
            <td class="subject"></td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 64px; position:relative; overflow:visible;" class="comp-header right-align border-btm"
                :class="{'trace-border-left': currentOpenComp===idx}">
                <div class="annotated" style="position: absolute; top:4px; left:-2px;">5a</div> Values
              </th>
              <th :class="{'adj-price' : currentOpenComp===idx }"
                class="comp1-header right-align border-btm money highlight-green2"
                style="width: 62px;position:relative;">
                <div class="annotated" style="position: absolute; top:4px;">5b</div>
                <span> {{unit_list_header[domainIdx]}} Œî </span>

              </th>
              <template v-for="i in row.adjusted_step_number">
                <th class="adj-value border-btm right-align" style="font-weight: bold;"
                  :class="{hidden: currentOpenComp!==idx}">Values</th>
                <th class="adj-price border-btm right-align money" style="font-weight: bold;" :class="{hidden: currentOpenComp!==idx, 
                  'trace-border-right': i === row.adjusted_price.length}">
                  {{unit_list_header[domainIdx]}} Œî
                </th>
              </template>
            </template>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(tb, index) in Features[domainIdx]">
            <td class="feature-name">
              <span>{{ Features[domainIdx][index] }}</span>
              <el-tooltip :content="FeatureDescriptions[domainIdx][index]" placement="right" effect="dark"
                :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">
              <el-tooltip :content="Targets[domainIdx]?.[currentTargetIndex].feature_val[index]" placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <div style=" display: inline-block;
                max-width: 62px;
                width: 62px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                vertical-align: top; cursor: pointer;">
                  {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] }}

                </div>
              </el-tooltip>
              <!-- <template v-else>
                <div style="cursor: default;">
                  {{ Targets[domain][currentTargetIndex].feature_val[index] }}
                </div>
              </template> -->

            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align"
                :class="{'gray-font': row.delta_y[index]==0, 'trace-border-left': currentOpenComp===idx}">
                <el-tooltip :content="row.feature_val[index]" placement="right" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  <div style=" display: inline-block;
                  max-width: 62px;
                  width: 62px;
                  overflow: hidden;
                  white-space: nowrap;
                  text-overflow: ellipsis;
                  vertical-align: top; cursor: pointer;">
                    {{ row.feature_val[index] }}

                  </div>
                </el-tooltip>
                <!-- <template v-else>
                  <div style="cursor: default;">{{ row.feature_val[index] }} </div>
                </template> -->
              </td>
              <td style="cursor: pointer;" class="comp1-header right-align money highlight-green2"
                :class="{'gray-font': row.delta_y[index]==0, 'adj-price' : currentOpenComp==idx }">
                <el-tooltip :content="getDeltayTooltip(row,index)" placement="top" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  {{row.delta_y[index]!==0? row.delta_y[index]+unit_list[domainIdx]:'0' }}
                </el-tooltip>
                <!-- {{row.delta_y[index]!==0? row.delta_y[index]+unit_list[domainIdx]:'0' }} -->
              </td>
              <template v-for="i in row.adjusted_step_number">
                <td class="right-align adj-value" :class="{hidden: currentOpenComp!==idx }"
                  :style="{ color: index == row.adjusted_order[i-1] ? '#222' : '#bcbcbc', cursor: index == row.adjusted_order[i-1] ? 'pointer' : 'default' }">
                  <!-- <span v-if="row.adjusted_order.slice(0,i).includes(index)"  style="cursor: pointer;"> -->
                  <span class="adj-value-span">

                    <!-- {{ row.feature_val[index] }} -->
                    <!-- <i class="fa-solid fa-arrow-right" style="font-size:10px;vertical-align:middle;"></i> -->
                    <el-tooltip v-if="index == row.adjusted_order[i-1]" :content="numberical_feature[domainIdx][index] ? 
                        row.feature_val[index]+' ‚Üí '+Targets[domainIdx]?.[currentTargetIndex].feature_val[index]+' (Œî: '+(row.delta_x[index] >= 0 ? '+' : '')+row.delta_x[index]+')' :
                        row.feature_val[index]+' ‚Üí '+Targets[domainIdx]?.[currentTargetIndex].feature_val[index]"
                      placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                      {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] }}
                    </el-tooltip>
                    <template v-else-if="row.adjusted_order.slice(0,i).includes(index)">
                      {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] }}
                    </template>
                    <template v-else>
                      {{Comparables[domainIdx]?.[currentTargetIndex][idx].feature_val[index]}}
                    </template>

                  </span>
                  <!-- <span v-else>
                    ‚Äî
                  </span> -->
                </td>
                <td class="right-align adj-price money"
                  :class="{hidden: currentOpenComp!==idx, 'trace-border-right': i === row.adjusted_price.length}"
                  :style="{ color: index ==
                 row.adjusted_order[i-1] ? '#2e8113' : '#bcbcbc' }">{{
                  row.adjusted_order.slice(0,i).includes(index)? row.delta_y[index]+unit_list[domainIdx] : ''}}</td>
              </template>
            </template>
          </tr>

          <tr class="">

            <td class="feature-name money highlight-green" style="position: relative; overflow:visible;">
              <div style="position: absolute; top:0; left:-30px;" class="annotated">3</div>
              {{Labels[domainIdx][0]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark" :show-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject money highlight-green" @mouseenter="highlightAllAdjustedPrices()"
              @mouseleave="unhighlightAllAdjustedPrices()" style="position: relative; overflow:visible;">
              <div class="annotated" style="position: absolute; top:0; left:-20px;">3a</div>
              <div style="cursor: pointer;">


                <el-tooltip :content="weightedAverageTooltipContent" placement="top" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  <span style="cursor: pointer;">
                    {{weightedAverageValue}}{{unit_list[domainIdx]}}
                  </span>
                </el-tooltip>

                <el-tooltip :content="warningContent" placement="top" effect="dark" :show-after="0" trigger="hover"
                  :hide-after="0">
                  <div class="approx-warning">
                    ‚âà
                  </div>
                </el-tooltip>

                </span>
              </div>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money highlight-green"
                :class="{ 'actual-price-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted, 'trace-border-left': currentOpenComp===idx }">
                <span>
                  {{row.actual}}{{unit_list[domainIdx]}}
              </td>
              <td :colspan="row.adjusted_step_number*2"
                class="right-align money comp-details highlight-green trace-border-right"
                :class="{hidden: currentOpenComp!==idx}" style="position:relative;">
                <!-- {{row.actual}}{{unit_list[domainIdx]}} -->
              </td>

            </template>
          </tr>
          <tr>
            <td class="feature-name money border-top highlight-green2 " style="position: relative; overflow:visible;">
              <div style="position: absolute; top:0; left:-30px;" class="annotation">7</div>
              {{Labels[domainIdx][2]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][2]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align money subject highlight-green2 border-top">‚Äî</td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money border-top highlight-green2"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted, 'trace-border-bottom': currentOpenComp===idx, 'trace-border-left': currentOpenComp===idx}"
                style="position:relative;">
                <span>{{row.adjusted_price[row.adjusted_step_number - 1]}}{{unit_list[domainIdx]}}
              </td>
              <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align money comp-details border-top highlight-green2 trace-border-bottom"
                  :class="{hidden: currentOpenComp!==idx, 'trace-border-right': i === row.adjusted_price.length - 1}"
                  style="position:relative;">
                  <span>{{ele}}{{unit_list[domainIdx]}}</span>
                </td>
              </template>
            </template>
          </tr>
          <!--  Reconsolidation -->

          <tr>
            <td class="feature-name" style="position: relative; overflow:visible;">
              <div style="position: absolute; top:0; left:-30px;" class="annotated">6</div>
              Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">‚Äî</td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}" style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>
              <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align comp-details" :class="{hidden: currentOpenComp!==idx}"
                  style="position:relative;">
                  <span></span>
                </td>
              </template>
            </template>
          </tr>
          <tr>
            <td style="height:20px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">

              </td>
            </template>
          </tr>

          <tr>
            <td class="feature-name money ai-pred-bg" style="position: relative; overflow:visible">
              <div style="position: absolute; top:0; left:-30px;" class="annotated">4</div>
              <div style="position: absolute; bottom:0; left:-30px;" class="annotated">4a</div>
              {{Labels[domainIdx][1]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>

              </span>
            </td>
            <td class="right-align money subject ai-pred-bg">
              {{Targets[domainIdx]?.[currentTargetIndex].pred}}{{unit_list[domainIdx]}} <br />
              <span class="pred-description"> ‚Äî </span>
            </td>

            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money ai-pred-bg"
                :class="{ 'pred-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted }">
                <span>
                  {{row.pred}}{{unit_list[domainIdx]}}
                  <br />
                  <el-tooltip
                    :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                    placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                    <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                      @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                  </el-tooltip>
              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align ai-pred-bg"
                :class="{hidden: currentOpenComp!==idx}">
                <!-- {{row.pred}}K -->
              </td>
            </template>
          </tr>
        </tbody>
      </table>

    </div>


  </div>

  <script>

    // parse query params
    function getParam(key, defaultValue) {
      const params = new URLSearchParams(window.location.search);
      return params.has(key) ? params.get(key) : defaultValue;
    }
    const domainKeyToIndex = { house: 0, energy: 1, salary: 2 };
    const initDomain = getParam('domain', 'house');
    const initTab = Number(getParam('tab', 0));
    const initInstance = Number(getParam('instanceId', 0));
    const initStep = getParam('step', '0');
    const initcurrentOpenComp = initStep == 3 ? 0 : null;


    const { createApp } = Vue;
    const { ElTooltip } = ElementPlus;

    createApp({
      components: {
        ElTooltip
      },
      data() {
        return {
          domain: initDomain,
          currentTab: initTab,
          currentTargetIndex: initInstance,
          currentTutStep: initStep,
          domain_list: [],
          unit_list: [],
          unit_list_header: [],
          categoryMappings: {},
          currentOpenComp: initcurrentOpenComp,
          highlightedActualPrice: null,
          allAdjustedPricesHighlighted: false,
          allPredAndActualHighlighted: false,
          warning: [
          ],
          Labels: [
            //domain 1
            [],
            //domain 2
            [],
            //domain 3
            []
          ],
          Labels_Descriptions: [
            //domain 1
            [],
            // domain 2
            [],
            //domain 3
            []],
          Features:
            [
              //domain 1
              [],
              //domain 2
              [],
              //domain 3
              []],
          numberical_feature: [
            //domain 1
            [],
            //domain 2
            [],
            //domain 3
            []
          ],
          FeatureDescriptions: [
            //domain 1
            [

            ],
            //domain 2
            [

            ],
            //domain 3
            [

            ]
          ],
          Targets: [],
          Comparables: [],
          Linear_reg: [],
        }
      },
      computed: {
        domainIdx() {
          return domainKeyToIndex[this.domain];
        },

        warningContent() {
          const msg = this.warning[this.domainIdx];
          return msg || 'Warning: estimate may be inaccurate.';
        },
        weightedAverageTooltipContent() {
          const comparables = this.Comparables[this.domainIdx][this.currentTargetIndex];
          if (!comparables || comparables.length === 0) return '';
          let formula = '';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].adjusted_price && comparables[idx].adjusted_price.length > 0
              ? comparables[idx].adjusted_price[comparables[idx].adjusted_step_number - 1]
              : 0;
            formula += `${weight}% √ó ${price}${this.unit_list[this.domainIdx]}`;
            if (idx < comparables.length - 1) formula += ' + ';
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return formula;
          const avg = (sum / totalWeight).toFixed(1);
          return `${formula} = ${avg}${this.unit_list[this.domainIdx]}`;
        },
        weightedAverageValue() {
          const comparables = this.Comparables[this.domainIdx][this.currentTargetIndex];
          if (!comparables || comparables.length === 0) return '-';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].adjusted_price && comparables[idx].adjusted_price.length > 0
              ? comparables[idx].adjusted_price[comparables[idx].adjusted_step_number - 1]
              : 0;
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return '-';
          return (sum / totalWeight).toFixed(1);
        },

        // for plain example based
        weightedAverageTooltipContentForComparable() {
          const comparables = this.Comparables[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.Comparables[this.domainIdx]) || comparables.length === 0) return '';

          let formula = '';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].actual
            formula += `${weight}% √ó ${price}${this.unit_list[this.domainIdx]}`;

            if (idx < comparables.length - 1) formula += ' + ';
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return formula;
          const avg = (sum / totalWeight).toFixed(1);
          return `${avg}${this.unit_list[this.domainIdx]} = ${formula}`;
        },
        weightedAverageValueForComparable() {
          const comparables = this.Comparables[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.Comparables[this.domainIdx]) || comparables.length === 0) return '-';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].actual
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return '-';
          return (sum / totalWeight).toFixed(1);
        },

        similarityScores() {
          const subject = this.Targets[this.domainIdx][this.currentTargetIndex];
          const comparables = this.Comparables[this.domainIdx][this.currentTargetIndex];
          if (!subject || !comparables) return [];

          const scores = comparables.map(comp => {
            let score = 0;
            for (let i = 0; i < comp.feature_val.length; i++) {
              const subjVal = subject.feature_val[i];
              const compVal = comp.feature_val[i];
              if (this.numberical_feature[this.domainIdx][i]) {
                // Âè™Âú®ÈÉΩËÉΩËΩ¨ÊàêÊï∞Â≠óÊó∂ÊâçÂä†ÂàÜ
                const subjNum = Number(subjVal);
                const compNum = Number(compVal);
                if (!isNaN(subjNum) && !isNaN(compNum)) {
                  const diff = Math.abs(subjNum - compNum);
                  score += 1 / (1 + diff);
                }
                // Âê¶Âàô‰∏çÁªôÂàÜ
              } else {
                // Categorical: 1 if equal, 0 if not
                score += subjVal === compVal ? 1 : 0;
              }
            }
            return score;
          });

          const total = scores.reduce((a, b) => a + b, 0);
          return scores.map(s => total ? Math.round((s / total) * 100) : 0);
        },

        currentComparableFinalPrices() {
          const comparables = this.Comparables[this.domainIdx][this.currentTargetIndex];
          if (!comparables || comparables.length === 0) return [];

          const finalPrices = [];
          comparables.forEach(comp => {
            if (comp.final_adjusted_price) {
              finalPrices.push(comp.final_adjusted_price);
            }
          });

          return finalPrices;
        },
        comparablePriceRange() {
          const prices = this.currentComparableFinalPrices;
          if (prices.length === 0) return { min: 350, max: 450 };

          const min = Math.min(...prices);
          const max = Math.max(...prices);
          return { min, max };
        },
        subjectActualValue() {
          const target = this.Targets[this.domainIdx][this.currentTargetIndex];
          return target && target.actual ? target.actual : '-';
        }
      },
      async mounted() {
        const [map1, map2] = await Promise.all([
          fetch('./data/domain1.json').then(r => r.json()),
          fetch('./data/domain2.json').then(r => r.json())
        ]);
        this.categoryMappings = {
          "1": map1,
          "2": map2
        }
        this.loadCSVData()
      },
      created() {
        if (this.currentTutStep === 3) {
          this.currentOpenComp = 0;
        }
      },
      watch: {
        domain() {
          this.currentTargetIndex = 0;
          this.showAnswer = false;
        },
        currentTargetIndex() {
          this.showAnswer = false;
        }
      },
      methods: {
        getDeltayTooltip(row, index) {
          const featureName = this.Features[this.domainIdx][index];
          const featureVal = row.feature_val[index];
          const targetVal = this.Targets[this.domainIdx]?.[this.currentTargetIndex].feature_val[index];
          const deltaY = row.delta_y[index];
          if (deltaY == 0) {
            return 'This attribute is same as the Subject, no adjustment needed'
          }
          const val = Number(deltaY) > 0 ? '+' + deltaY : deltaY
          return `Change ${featureName} from ${featureVal} to ${targetVal} will adjust ${val}${this.unit_list[this.domainIdx]}`;
        },
        async loadCSV(filename) {
          return new Promise((resolve, reject) => {
            Papa.parse(filename, {
              download: true,
              header: true,
              dynamicTyping: true,
              skipEmptyLines: true,
              complete: (results) => {
                resolve(results.data);
              },
              error: (error) => {
                reject(error);
              }
            });
          });
        },
        // CSV data loading methods
        async loadCSVData() {
          try {
            // load all CSV files
            const [domainMetadata, metadata, subjects, comparables, linear_reg] = await Promise.all([
              this.loadCSV('./data/domain_metadata.csv'),
              this.loadCSV('./data/metadata.csv'),
              this.loadCSV('./data/tutorial/subject.csv'),
              this.loadCSV('./data/tutorial/comparables.csv'),
              this.loadCSV('./data/tutorial/linear_reg.csv'),
            ]);
            console.log('loaded');

            // Process domain metadata
            this.processDomainMetadata(domainMetadata);

            // Process feature metadata
            this.processFeatureMetadata(metadata);
            // Process subjects (Targets)
            // Process subjects (Targets)
            this.processSubjects(subjects);
            this.processComparables(comparables)
            this.processLinearReg(linear_reg);


          } catch (error) {
            console.error('Error loading CSV data:', error);
          }

        },
        processDomainMetadata(data) {
          // Initialize arrays with correct size
          const domainCount = Math.max(...data.map(row => row.domainId)) + 1;

          this.domain_list = new Array(domainCount);
          this.unit_list = new Array(domainCount);
          this.unit_list_header = new Array(domainCount);
          this.warning = new Array(domainCount);
          this.Labels = new Array(domainCount).fill(null).map(() => []);
          this.Labels_Descriptions = new Array(domainCount).fill(null).map(() => []);

          data.forEach(row => {
            const idx = row.domainId;
            this.domain_list[idx] = row.domainName;
            this.unit_list[idx] = row.unit;
            this.unit_list_header[idx] = row.unitHeader;
            this.warning[idx] = row.warning;
            this.Labels[idx] = [row.labelActual, row.labelPrediction, row.labelAdjusted];
            this.Labels_Descriptions[idx] = [row.descriptionActual, row.descriptionPrediction, row.descriptionAdjusted];
          });
          console.log("finished process domain metadata")
        },
        processFeatureMetadata(data) {
          // Group by domainId
          const grouped = {};
          data.forEach(row => {
            if (!grouped[row.domainId]) {
              grouped[row.domainId] = [];
            }
            grouped[row.domainId].push(row);
          });

          // Initialize arrays
          const domainCount = Math.max(...Object.keys(grouped).map(Number)) + 1;
          this.Features = new Array(domainCount).fill(null).map(() => []);
          this.FeatureDescriptions = new Array(domainCount).fill(null).map(() => []);
          this.numberical_feature = new Array(domainCount).fill(null).map(() => []);

          // Fill arrays
          Object.keys(grouped).forEach(domainId => {
            const domainIdx = Number(domainId);
            const features = grouped[domainId].sort((a, b) => a.featureId - b.featureId);

            this.Features[domainIdx] = features.map(f => f.featureName);
            this.FeatureDescriptions[domainIdx] = features.map(f => f.featureDescription);
            this.numberical_feature[domainIdx] = features.map(f => f.isNumerical);

          });
          console.log("finished process feature metadata")
        },
        processSubjects(data) {
          // Group by domainId and instanceId
          const grouped = {};
          data.forEach(row => {
            if (!grouped[row.domainId]) {
              grouped[row.domainId] = {};
            }
            const domainId = row.domainId;
            const numFlags = this.numberical_feature?.[domainId] || [];  // e.g. [true, false, ...]
            // Extract feature values
            const featureVals = extract_features(row, domainId, numFlags, this)

            grouped[row.domainId][row.instanceId] = {
              feature_val: featureVals,
              pred: row.pred,
              actual: row.actual
            };
          });

          // Convert to array format
          const domainCount = Math.max(...Object.keys(grouped).map(Number)) + 1;
          this.Targets = new Array(domainCount).fill(null).map(() => []);

          Object.keys(grouped).forEach(domainId => {
            const domainIdx = Number(domainId);
            const instances = grouped[domainId];
            const maxInstance = Math.max(...Object.keys(instances).map(Number));

            for (let i = 0; i <= maxInstance; i++) {
              this.Targets[domainIdx][i] = instances[i] || null;
            }
          });
          console.log("finished process subject")
        },
        processComparables(data) {

          // Group by domainId, instanceId, and comparableId
          const grouped = {};

          data.forEach(row => {
            if (!grouped[row.domainId]) {
              grouped[row.domainId] = {};
            }
            if (!grouped[row.domainId][row.instanceId]) {
              grouped[row.domainId][row.instanceId] = {};
            }
            const domainId = row.domainId;
            const numFlags = this.numberical_feature?.[domainId] || [];  // e.g. [true, false, ...]


            // Extract feature values and deltas

            const deltaX = [];
            const deltaY = [];
            const featureVals = extract_features(row, domainId, numFlags, this)
            for (let i = 0; i < 6; i++) {
              const val = row[`feature${i}`];

              const dx = row[`delta_x${i}`];
              const dy = row[`delta_y${i}`];

              const dxVal = Number(dx);
              const dyVal = Number(dy);
              deltaX.push(!isNaN(dxVal) ? dxVal.toFixed(1) : '0.0');
              deltaY.push(!isNaN(dyVal) ? dyVal.toFixed(1) : '0.0');
            }

            // Parse adjusted_order and adjusted_price arrays
            let adjustedOrder = [];
            let adjustedPrice = [];

            // Handle adjusted_order - could be string, array, or null
            if (row.adjusted_order) {
              if (typeof row.adjusted_order === 'string') {
                adjustedOrder = row.adjusted_order.split(',').map(Number);
              } else if (Array.isArray(row.adjusted_order)) {
                adjustedOrder = row.adjusted_order.map(Number);
              } else {
                adjustedOrder = [row.adjusted_order].map(Number);
              }
            }

            // Handle adjusted_price - could be string, array, or null
            if (row.adjusted_price) {
              if (typeof row.adjusted_price === 'string') {
                adjustedPrice = row.adjusted_price.split(',').map(Number);
              } else if (Array.isArray(row.adjusted_price)) {
                adjustedPrice = row.adjusted_price.map(Number);
              } else {
                adjustedPrice = [row.adjusted_price].map(Number);
              }
            }

            grouped[row.domainId][row.instanceId][row.comparableId] = {
              id: row.comparableId,
              feature_val: featureVals,
              delta_x: deltaX,
              delta_y: deltaY,
              pred: row.pred,
              actual: row.actual,
              adjusted_step_number: row.adjusted_step_number,
              adjusted_order: adjustedOrder,
              adjusted_price: adjustedPrice,
              final_adjusted_price: adjustedPrice[adjustedPrice.length - 1] || 0
            };
          });

          // Convert to array format
          const domainCount = Math.max(...Object.keys(grouped).map(Number)) + 1;
          this.Comparables = new Array(domainCount).fill(null).map(() => []);

          Object.keys(grouped).forEach(domainId => {
            const domainIdx = Number(domainId);
            const instances = grouped[domainId];

            Object.keys(instances).forEach(instanceId => {
              const instanceIdx = Number(instanceId);
              if (!this.Comparables[domainIdx][instanceIdx]) {
                this.Comparables[domainIdx][instanceIdx] = [];
              }

              const comparables = instances[instanceId];
              Object.keys(comparables).sort((a, b) => Number(a) - Number(b)).forEach(comparableId => {
                this.Comparables[domainIdx][instanceIdx].push(comparables[comparableId]);
              });
            });
          });

          // Ensure all instances have a Comparables array, even if empty
          for (let domainIdx = 0; domainIdx < this.Targets.length; domainIdx++) {
            const instances = this.Targets[domainIdx] || [];
            for (let instanceIdx = 0; instanceIdx < instances.length; instanceIdx++) {
              if (!this.Comparables[domainIdx]) {
                this.Comparables[domainIdx] = [];
              }
              if (!this.Comparables[domainIdx][instanceIdx]) {

                this.Comparables[domainIdx][instanceIdx] = [];
              }
            }
          }
        },

        processLinearReg(data) {

          const grouped = {};
          data.forEach(row => {
            const d = Number(row.domainId);
            const i = Number(row.instanceId);
            if (!grouped[d]) grouped[d] = {};
            // Collect intercept and coefficients
            const coefs = [
              Number(row.coef_0), Number(row.coef_1), Number(row.coef_2),
              Number(row.coef_3), Number(row.coef_4), Number(row.coef_5)
            ];
            const features_val = Array.from({ length: 6 }, (_, k) =>
              Number(row[`feature${k}`])
            );
            console.log("processing linear", row)
            grouped[d][i] = {
              intercept: Number(row.intercept.toFixed(1)),
              coefs,
              features_val,
              linear_pred: Number(row.linear_pred.toFixed(1))
            };
          });

          // Prepare the Linear_reg array with correct dimensions
          const maxDomain = Math.max(...data.map(r => Number(r.domainId)));
          this.Linear_reg = Array.from({ length: maxDomain + 1 }, () => []);

          // Fill in the regression info, leaving gaps as null
          Object.entries(grouped).forEach(([domainKey, insts]) => {
            const d = Number(domainKey);
            const maxInst = Math.max(...Object.keys(insts).map(n => Number(n)));
            for (let idx = 0; idx <= maxInst; idx++) {
              this.Linear_reg[d][idx] = insts[idx] || null;
            }
          });
          console.log("this.Linear_reg", this.Linear_reg)
        },
        getLinearTooltipRows(domainIdx, instanceIdx) {
          const lr = this.Linear_reg[domainIdx]?.[instanceIdx];
          const target = this.Targets[domainIdx]?.[instanceIdx];

          if (!lr || !target) return [];
          const names = this.Features[domainIdx] || [];
          const values = target.feature_val || [];
          const cal_values = lr.features_val || [];

          // Build each row: name, value, factor text, partial = coef * value
          return lr.coefs.map((coef, j) => {

            const name = names[j] || `x${j}`;
            const val = values[j];
            const factor = `${coef.toFixed(1)}`;
            const partial = (coef * Number(cal_values[j])).toFixed(1);

            return { name, value: val, factor, partial };
          });
        },
        computeLinearTooltip(domainIdx, instanceIdx) {
          const lr = this.Linear_reg[domainIdx]?.[instanceIdx];
          const target = this.Targets[domainIdx]?.[instanceIdx];
          if (!lr || !target) return '';
          const featureNames = this.Features[domainIdx] || [];
          const featureVals = target.feature_val || [];
          const terms = [String(lr.intercept.toFixed(1))];
          lr.coefs.forEach((coef, j) => {
            const fname = featureNames[j] ?? `x${j}`;
            const fval = featureVals[j] ?? '';
            if (coef != 0) {
              coef = coef.toFixed(1)
              terms.push(`${String(coef)}√ó${fname}(${String(fval)})`);
            }

          });
          const formula = terms.join(' + ');

          return `${formula} = ${String(lr.linear_pred.toFixed(1))}`;
        },
        highlightActualPrice(idx) {
          this.highlightedActualPrice = idx;
        },
        unhighlightActualPrice() {
          this.highlightedActualPrice = null;
        },
        highlightAllAdjustedPrices() {
          this.allAdjustedPricesHighlighted = true;
        },
        unhighlightAllAdjustedPrices() {
          this.allAdjustedPricesHighlighted = false;
        },
        highlightAllPredAndActual() {
          this.allPredAndActualHighlighted = true;
        },
        unhighlightAllPredAndActual() {
          this.allPredAndActualHighlighted = false;
        },

        toggleCols(group, idx) {
          if (this.currentOpenComp == idx) {
            this.currentOpenComp = null
          } else {
            this.currentOpenComp = idx
          }
          console.log("group", group)
        },
        nextTarget() {
          if (this.currentTargetIndex < this.Targets[this.domainIdx].length - 1) {
            this.currentTargetIndex++;
            this.currentOpenComp = null;
          }
        },
        prevTarget() {
          if (this.currentTargetIndex > 0) {
            this.currentTargetIndex--;
            this.currentOpenComp = null;
          }
        },
        getPredictionDifference(row) {
          if (row.pred === 0 || row.actual === 0) {
            return "‚Äî";
          }

          const difference = row.pred - row.actual;
          const percentage = Math.abs((difference / row.actual) * 100);
          const roundedPercentage = Math.round(percentage * 10) / 10; // Round to 1 decimal place

          if (difference > 0) {
            return `${roundedPercentage}% Higher`;
          } else if (difference < 0) {
            return `${roundedPercentage}% Lower`;
          } else {
            return "0% (Same)";
          }
        },

      }
    }).mount('#app');
  </script>

</body>

</html>