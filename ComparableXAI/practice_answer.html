<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Comparable XAI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <!-- Element UI CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>


  <link rel="stylesheet" href="./index.css">
  <script src="./utils.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    table {
      /* width: 100%; */
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 14px;
      font-family: 'Roboto Condensed', monospace;
      color: #212121;


    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 6px;
      transition: max-width 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 200px;
      opacity: 1;
      overflow: hidden;
      white-space: nowrap;


    }

    th {
      font-size: 14px;
      font-family: sans-serif;
      /*background-color: #f0f8ff;*/
    }

    table,
    th,
    td {
      border: none;

    }



    .hidden {
      max-width: 0 !important;
      opacity: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      border-width: 0 !important;
      pointer-events: none;
    }

    .comp1,
    .comp2 {
      width: 40px;
      background-color: #fef6e4;
      transition: max-width 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .comp-header {
      font-size: 14px;

    }

    .highlight-blue {
      background-color: #e8f3fd;
    }

    .highlight-green2,
    .adj-price {
      background-color: #e4fcdc !important;
    }


    .highlight-green {
      background-color: #baf2a7 !important;
    }

    .adj-price {
      width: 62px;
      padding-right: 10px;
      border-right: 1px solid #36a341;
    }

    .green-right-border {
      border-right: 1px solid #36a341;
    }

    .adj-value {
      width: 42px;
      font-weight: 400;
      padding-right: 10px;
    }

    .adj-value-span {
      display: inline-block;
      width: 62px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }


    .comp-details,
    .adj-value {
      /* background-color: #f4fdf1; */
      background-color: #ffffff;

    }

    .highlight-yellow {
      background-color: #fef6e4;
    }

    .sub-header {
      background-color: #f0f0f0;
      font-weight: normal;
      font-size: 0.9em;
    }

    .clickable-header {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: bold;
      color: #0074d9;
      transition: color 0.2s;
    }

    .clickable-header:hover {
      color: #005fa3;
      text-decoration: underline;
    }

    .arrow {
      transition: transform 0.2s;
      display: inline-block;
    }

    .arrow.open {
      transform: rotate(180deg);
    }

    .toggle-text {
      width: 12px;
      line-height: 16px;
    }



    .adj-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .money {
      /* font-family: 'Roboto Mono', monospace; */
      font-family: 'Roboto Condensed', monospace;
      font-size: 14px;
      font-variant-numeric: tabular-nums;
      /* 等宽数字对齐 */
      letter-spacing: 0.5px;
      font-weight: 1200;
      color: #2e8113;

    }

    .adj-grey {
      color: #ccc;
      font-size: 1em;
      width: 30px;
      text-align: right;
    }


    .gray-bg {
      background-color: #ededed !important;
    }

    .adj-black {
      color: #222;
      font-weight: 500;
      font-size: 1em;
      width: 40px;
      text-align: left;
    }

    .plain-xai-table {
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
      min-width: 650px;
    }

    th {
      font-family: sans-serif;
    }

    .feature-name {
      font-size: 14px;
      text-align: left;
      font-weight: 400;

      font-family: sans-serif;
    }

    .right-align {
      text-align: right;
    }

    .left-align {
      text-align: left;
    }

    .plain-xai-table {
      border: none;
    }

    .plain-xai-table th,
    .plain-xai-table td {

      padding: 6px 12px;

    }

    .plain-xai-table th {
      font-weight: bold;
    }

    .plain-xai-table tr td:first-child {

      font-weight: 500;
    }

    .gray-bg {
      background-color: #ededed !important;
      color: #ccc;
    }

    .gray-font {
      color: #ccc;
    }

    .nav-btn {
      background: #0074d9;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px 0 #0074d91a;
    }

    .nav-btn:disabled {
      background: #e5e7eb;
      color: #aaa;
      cursor: not-allowed;
      box-shadow: none;
    }

    .nav-btn:not(:disabled):hover {
      background: #005fa3;
      color: #fff;
    }


    .border-btm {
      border-bottom: 1px solid #666;
    }

    .border-top {
      border-top: 1px solid #666;
    }

    .toggle-button {
      cursor: pointer;
      margin: 2px 0;
    }

    .toggle-button:hover {
      background: #cbf4be;
    }

    .subject {
      padding-right: 20px;
    }

    .detail-header-bg {
      background-attachment: #cbf4be !important;
    }

    .border-wider {
      border-top: 2px solid #a4a4a4;
    }

    .ai-pred-bg {
      /*background-color: #cbf4be;*/
      background-color: #ffffff;

    }

    .pred-description {
      color: #bd3030;
      padding: 2px 0 2px 0px;
      margin-top: 4px;
      display: inline-block;
      cursor: pointer;
    }

    /* Slider styles */
    .slider-container {
      margin-top: 15px;
      padding: 15px;
      border-radius: 6px;
      border: 1px dashed #222;
      max-width: 600px;
    }

    .slider-label {

      font-weight: 500;
      color: #495057;
      margin-bottom: 8px;
      display: block;
    }

    .slider-track {
      position: relative;
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      margin: 15px 0;
    }

    .slider-fill {
      position: absolute;
      height: 100%;
      background: #28a745;
      border-radius: 2px;
      top: 0;
    }

    .slider-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #fff;
      border: 2px solid #2e8113;
      border-radius: 50%;
      top: -6px;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }

    .slider-handle:hover {
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .slider-handle.active {
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
    }

    .slider-values {
      display: flex;
      justify-content: space-between;
      align-items: center;

      color: #6c757d;
      margin-top: 8px;
    }

    .disabled-input {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #2e8113;
      padding: 2px 6px;
      border-radius: 4px;

      font-family: 'Roboto Condensed', monospace;
      width: 50px;
      text-align: right;
      cursor: not-allowed;
    }

    .actual-price-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .pred-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .adjusted-price-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .all-pred-actual-highlight {
      /*font-size: 18px !important;*/
      font-weight: bold !important;
      text-decoration: underline !important;
      transition: all 0.3s ease;
    }

    .tooltip-icon {
      cursor: pointer;
      margin-left: 2px;
      font-size: 10px;
      display: inline-block;
    }

    .trace-border-top {
      border-top: 2px solid #36a341;
    }

    .trace-border-bottom {
      border-bottom: 2px solid #36a341;
    }

    .trace-border-right {
      border-right: 2px solid #36a341;
    }

    .trace-border-left {
      border-left: 2px solid #36a341;
    }
    u{
      font-weight: 800;
    }
  </style>
</head>

<body>

  <div id="app">
    <div class="tab-content" v-if="xaiType=='noXAI'">

      <table class="plain-xai-table" style="border-collapse: separate; border-spacing: 4px 0;">
        <thead>

          <tr>
            <th>

            </th>
            <th
              class="subject right-align border-btm annotation-border-top annotation-border-left annotation-border-right"
              style="width: 62px;">Subject</th>
          </tr>
        </thead>
        <tbody>
          <template v-for="(feature, index) in Features[domainIdx]">
            <tr>
              <td class="feature-name annotation-border-left annotation-border-right"
                :class="{'annotation-border-top':index==0, 'annotation-border-btm':index==Features[domainIdx].length-1}">
                {{feature}}
                <el-tooltip :content="FeatureDescriptions[domainIdx][index]" placement="right" effect="dark"
                  :show-after="0">
                  <span class="tooltip-icon" style="cursor: pointer; margin-left: 4px;">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </td>
              <td class="right-align annotation-border-left annotation-border-right" style="cursor:pointer"
                :class="{'annotation-border-btm':index==Features[domainIdx].length-1}">
                <el-tooltip :content="Targets[domainIdx][currentTargetIndex].feature_val[index]" placement="right"
                  effect="dark" :show-after="0">
                  <span class="adj-value-span"
                    style="width: 100px;">{{Targets[domainIdx][currentTargetIndex].feature_val[index]}}</span>
              </td>
              </el-tooltip>
            </tr>
          </template>
          <tr>
            <td colspan="2" style="padding: 0; overflow: visible;">
              <!-- sub tabel -->
              <table class="highlight-green"
                style="overflow: visible; width: 100%; border-collapse: collapse; margin:0;">
                <tr style="overflow: visible;">

                  <td style="width: 140px; position: relative; overflow: visible;"
                    class="feature-name money highlight-green">

                    {{ Labels[domainIdx][0] }}
                    <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark"
                      :show-after="0" trigger="hover" :hide-after="0">
                      <span class="tooltip-icon">
                        <i class="fa-regular fa-circle-question"></i>
                      </span>
                    </el-tooltip>
                  </td>
                  <td class="right-align money highlight-green" style="cursor: pointer;">
                    <el-tooltip placement="right" effect="dark" :show-after="0"
                      trigger="hover" :hide-after="0">
                      <u>Answer: {{Targets[domainIdx]?.[currentTargetIndex].actual}}{{unit_list[domainIdx]}}</u>
                    </el-tooltip>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <tr>
            <td style="height:0px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>
              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">
              </td>
            </template>
          </tr>

          <tr>
            <td style="width: 140px; position:relative; overflow:visible;" class="feature-name money">

              {{Labels[domainIdx][1]}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span style="cursor: pointer; margin-left: 6px; font-size:12px;  color:#bd3030">
                  <!-- <i class="bi bi-exclamation-circle"></i> -->
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align money">{{Targets[domainIdx][currentTargetIndex].pred}}{{unit_list[domainIdx]}}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="tab-content" v-if="xaiType === 'trace' || xaiType === 'comparableXAI'">
      <table>
        <thead>
          <!-- Header row -->
          <tr style="border-top:2px solid transparent">
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header right-align subject" style="width: 50px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id"
              class="comp1-header" style="position:relative;">
              <th colspan="2" class="comp1-header right-align border-btm"
                :class="{'trace-border-left': currentOpenComp===idx, 'trace-border-top': currentOpenComp===idx, 'green-right-border': currentOpenComp===idx}"
                style="position:relative;">
                Comparable {{idx + 1}}
                <el-tooltip v-if="xaiType=='trace'" :content="currentOpenComp==idx ? 'Hide Trace' : 'Show Trace'"
                  placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <button class="toggle-button" @click="toggleCols(`comp${idx+1}`,idx)">

                    <span v-if="currentOpenComp!=idx" class="toggle-text">{{ currentOpenComp ==idx ? ' ' : '...'
                      }}</span>

                    <i class="toggle-text fa-solid fa-angle-left" v-if="currentOpenComp==idx"></i>

                  </button>
                </el-tooltip>
              </th>

              <template v-for="i in row.adjusted_step_number">
                <th class="border-btm comp-details trace-border-top green-right-border" style="" colspan="2" :class="{hidden: currentOpenComp!==idx, 
                  'trace-border-right': i === row.adjusted_price.length}">
                  {{ i === row.adjusted_price.length ? '≈ Subject' : i }}</th>
              </template>

            </template>
          </tr>


          <tr>
            <td class="comp1-header"></td>
            <td class="subject"></td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <th style="width: 62px;" class="comp-header right-align border-btm"
                :class="{'trace-border-left': currentOpenComp===idx}">Values</th>
              <th :class="{'adj-price' : currentOpenComp===idx }"
                class="comp1-header right-align border-btm money highlight-green2" style="width: 62px;">
                <span> {{unit_list_header[domainIdx]}} Δ </span>
                <!-- <button class="toggle-button" @click="toggleCols(`comp${idx+1}`,idx)">
                  <span v-if="currentOpenComp!=idx" class="toggle-text">{{ currentOpenComp ==idx ? ' ' : '...' }}</span>
                  <i class="toggle-text fa-solid fa-angle-left" v-if="currentOpenComp==idx"></i>
                </button> -->
              </th>
              <template v-for="i in row.adjusted_step_number">
                <th class="adj-value border-btm right-align" style="font-weight: bold;"
                  :class="{hidden: currentOpenComp!==idx}">Values</th>
                <th class="adj-price border-btm right-align money" style="font-weight: bold;" :class="{hidden: currentOpenComp!==idx, 
                  'trace-border-right': i === row.adjusted_price.length}">
                  {{unit_list_header[domainIdx]}} Δ
                </th>
              </template>
            </template>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(tb, index) in Features[domainIdx]">
            <td class="feature-name">
              <span>{{ Features[domainIdx][index] }}</span>
              <el-tooltip :content="FeatureDescriptions[domainIdx]?.[index] || '' " placement="right" effect="dark"
                :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">
              <el-tooltip :content="Targets[domainIdx]?.[currentTargetIndex].feature_val[index] || '' "
                placement="right" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <div style=" display: inline-block;
                max-width: 62px;
                width: 62px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                vertical-align: top; cursor: pointer;">
                  {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] || '' }}

                </div>
              </el-tooltip>

            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align"
                :class="{'gray-font': row.delta_x[index]==0, 'trace-border-left': currentOpenComp===idx}">
                <el-tooltip :content="row.feature_val[index]" placement="right" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  <div style=" display: inline-block;
                  max-width: 62px;
                  width: 62px;
                  overflow: hidden;
                  white-space: nowrap;
                  text-overflow: ellipsis;
                  vertical-align: top; cursor: pointer;">
                    {{ row.feature_val[index] }}

                  </div>
                </el-tooltip>

              </td>
              <td style="cursor: pointer;" class="comp1-header right-align money highlight-green2"
                :class="{'gray-font': row.delta_x[index]==0, 'adj-price' : currentOpenComp==idx }">
                <el-tooltip :content="getDeltayTooltip(row,index)" placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  {{row.delta_y[index]!==0? row.delta_y[index]+unit_list[domainIdx]:'0' }}
                </el-tooltip>
                  
                
              </td>
              <template v-for="i in row.adjusted_step_number">
                <td class="right-align adj-value" :class="{hidden: currentOpenComp!==idx }"
                  :style="{ color: index == row.adjusted_order[i-1] ? '#222' : '#bcbcbc', cursor: index == row.adjusted_order[i-1] ? 'pointer' : 'default' }">
                  <!-- <span v-if="row.adjusted_order.slice(0,i).includes(index)"  style="cursor: pointer;"> -->
                  <span class="adj-value-span">

                    <!-- {{ row.feature_val[index] }} -->
                    <!-- <i class="fa-solid fa-arrow-right" style="font-size:10px;vertical-align:middle;"></i> -->
                    <el-tooltip v-if="index == row.adjusted_order[i-1]" :content="numberical_feature[domainIdx][index] ? 
                        row.feature_val[index]+' → '+Targets[domainIdx]?.[currentTargetIndex].feature_val[index]+' (Δ: '+(row.delta_x[index] >= 0 ? '+' : '')+row.delta_x[index]+')' :
                        row.feature_val[index]+' → '+Targets[domainIdx]?.[currentTargetIndex].feature_val[index]"
                      placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                      {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] || '' }}
                    </el-tooltip>
                    <template v-else-if="row.adjusted_order.slice(0,i).includes(index)">
                      {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] || '' }}
                    </template>
                    <template v-else>
                      {{Comparables[domainIdx]?.[currentTargetIndex][idx].feature_val[index]}}
                    </template>

                  </span>

                </td>
                <td class="right-align adj-price money"
                  :class="{hidden: currentOpenComp!==idx, 'trace-border-right': i === row.adjusted_price.length}"
                  :style="{ color: index ==
                 row.adjusted_order[i-1] ? '#2e8113' : '#bcbcbc' }">{{
                  row.adjusted_order.slice(0,i).includes(index)? row.delta_y[index]+unit_list[domainIdx] : ''}}</td>
              </template>
            </template>
          </tr>

          <tr class="">
            <td class="feature-name money highlight-green">{{Labels[domainIdx]?.[0] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark" :show-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject money highlight-green" @mouseenter="highlightAllAdjustedPrices()"
              @mouseleave="unhighlightAllAdjustedPrices()">
              <div style="cursor: pointer;">

                <el-tooltip placement="top" effect="light" :show-after="0" trigger="hover" :hide-after="0">
                  <template #content>
                    <span>Reconciled price (from adjusted Comparables): {{weightedAverageValue}}</span><br />
                    <span style="color: #bd3030;">Estimation Error: {{getEstimationDifference(weightedAverageValue, Targets[domainIdx]?.[currentTargetIndex].actual)}}</span>
                    <br />
                  </template>
                 <u>Answer: {{Targets[domainIdx]?.[currentTargetIndex].actual}}{{unit_list[domainIdx]}}</u>
                </el-tooltip>

                </span>
              </div>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money highlight-green"
                :class="{ 'actual-price-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted, 'trace-border-left': currentOpenComp===idx }">
                <span>
                  {{row.actual}}{{unit_list[domainIdx]}}
              </td>
              <td :colspan="row.adjusted_step_number*2"
                class="right-align money comp-details highlight-green trace-border-right"
                :class="{hidden: currentOpenComp!==idx}" style="position:relative;">
                <!-- {{row.actual}}{{unit_list[domainIdx]}} -->
              </td>
              <!-- <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align money comp-details highlight-green"
                  :class="{hidden: currentOpenComp!==idx, 'trace-border-right': i === row.adjusted_price.length - 1}"
                  style="position:relative;">
                  <span>{{row.actual}}{{unit_list[domainIdx]}}</span>
                </td>
              </template> -->
            </template>
          </tr>
          <tr>
            <td class="feature-name money border-top highlight-green2 ">{{Labels[domainIdx]?.[2] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][2]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align money subject highlight-green2 border-top">—</td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money border-top highlight-green2"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted, 'trace-border-bottom': currentOpenComp===idx, 'trace-border-left': currentOpenComp===idx}"
                style="position:relative;">
                <span>{{row.adjusted_price[row.adjusted_step_number - 1]}}{{unit_list[domainIdx]}}
              </td>
              <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align money comp-details border-top highlight-green2 trace-border-bottom"
                  :class="{hidden: currentOpenComp!==idx, 'trace-border-right': i === row.adjusted_price.length - 1}"
                  style="position:relative;">
                  <span>{{ele}}{{unit_list[domainIdx]}}</span>
                </td>
              </template>
            </template>
          </tr>
          <!--  Reconsolidation -->

          <tr v-if="Comparables[domainIdx]?.[currentTargetIndex]?.length>1">
            <td class="feature-name">Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">—</td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}" style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>
              <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align comp-details" :class="{hidden: currentOpenComp!==idx}"
                  style="position:relative;">
                  <span></span>
                </td>
              </template>
            </template>
          </tr>
          <tr>
            <td style="height:20px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">

              </td>
            </template>
          </tr>

          <tr>
            <td class="feature-name money ai-pred-bg">{{Labels[domainIdx]?.[1] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>

              </span>
            </td>
            <td class="right-align money subject ai-pred-bg">
              {{Targets[domainIdx]?.[currentTargetIndex].pred}}{{unit_list[domainIdx]}} <br />
              <span class="pred-description"> {{getEstimationDifference(Targets[domainIdx]?.[currentTargetIndex].pred, Targets[domainIdx]?.[currentTargetIndex].actual)}} </span>
            </td>

            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money ai-pred-bg"
                :class="{ 'pred-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted }">
                <span>
                  {{row.pred}}{{unit_list[domainIdx]}}
                  <br />
                  <el-tooltip
                    :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                    placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                    <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                      @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                  </el-tooltip>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align ai-pred-bg"
                :class="{hidden: currentOpenComp!==idx}">
                <!-- {{row.pred}}K -->
              </td>
            </template>
          </tr>
        </tbody>
      </table>


    </div>
    <div class="tab-content" v-if="xaiType == 'comparable'" class="tab-content">
      <table class="plain-xai-table">
        <thead>
          <tr>
            <th></th>
            <th class="subject right-align border-btm" style="width: 62px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 62px;" class="right-align border-btm">Comparable {{idx+1}}</th>
            </template>

          </tr>

        </thead>
        <tbody>
          <template v-for="(feature, index) in Features[domainIdx]">
            <tr>
              <td class="feature-name">
                {{feature}}
                <el-tooltip :content="FeatureDescriptions[domainIdx]?.[index] || ''" placement="right" effect="dark"
                  :show-after="0">
                  <span class="tooltip-icon" style="cursor: pointer; margin-left: 4px;">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </td>
              <td class="right-align">{{Targets[domainIdx]?.[currentTargetIndex].feature_val[index]}}</td>
              <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
                <td class="right-align" :style="{ color: row.feature_val[index] ==
                Targets[domainIdx]?.[currentTargetIndex].feature_val[index] ? '#ccc' : '#222' }">{{row.feature_val[index]}}</td>
              </template>
            </tr>

          </template>
          <tr>
            <td style="width: 140px;" class="feature-name money highlight-green">{{Labels[domainIdx]?.[0] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>

            <td class="right-align money highlight-green" style="cursor: pointer;">
              <el-tooltip placement="top" effect="light" :show-after="0" trigger="hover" :hide-after="0">
                <template #content>
                  Estimated value based on {{Comparables[domainIdx]?.[currentTargetIndex]?.length}} Comparable{{Comparables[domainIdx]?.[currentTargetIndex]?.length>1?'s':''}}:<br />
                  {{weightedAverageTooltipContentForComparable}}<br />
                  
                  <span style="width:60px;color:#bd3030; font-size:12px; font-weight:400; line-height:12px;">
                    Estimation error: {{getEstimationDifference(weightedAverageValueForComparable, Targets[domainIdx]?.[currentTargetIndex].actual)}}
                  </span>

                </template>
                <!-- <div>
                  {{weightedAverageValueForComparable}}
                  <div class="approx-warning">
                    ≈
                  </div>
                </div> -->
                <u>Answer: {{Targets[domainIdx]?.[currentTargetIndex].actual}}{{unit_list[domainIdx]}}</u>

              </el-tooltip>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="right-align money highlight-green">{{row.actual}}{{unit_list[domainIdx]}}</td>
            </template>
          </tr>

          <tr v-if="Comparables[domainIdx]?.[currentTargetIndex]?.length>1">
            <td class="feature-name">Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">—</td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align" :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}"
                style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>
              <!-- <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align comp-details" :class="{hidden: currentOpenComp!==idx}"
                  style="position:relative;">
                  <span></span>
                </td>
              </template> -->
            </template>
          </tr>

          <tr>
            <td style="height:8px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">

              </td>
            </template>
          </tr>



          <tr>
            <td style="width: 140px;" class="feature-name money">{{Labels[domainIdx]?.[1] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <!-- <i class="fa-regular fa-circle-question"></i> -->
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </span>
            </td>

            <td class="right-align money">{{Targets[domainIdx]?.[currentTargetIndex].pred}}{{unit_list[domainIdx]}}
              <br> <span style="color: #bd3030;">{{getEstimationDifference(Targets[domainIdx]?.[currentTargetIndex].pred, Targets[domainIdx]?.[currentTargetIndex].actual)}}</span>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="right-align money">{{row.pred}}{{unit_list[domainIdx]}}
                <br />
                <el-tooltip
                  :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                  placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                    @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                </el-tooltip>
              </td>
            </template>

          </tr>

        </tbody>
      </table>
    </div>
    <div v-if="xaiType == 'linear_adjustments'">
      <table>
        <thead>
          <!-- Header row -->
          <tr style="border-top:2px solid transparent">
            <th rowspan="1" style="width: 100px;"></th>
            <th class="comp1-header right-align subject" style="width: 50px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id"
              class="comp1-header" style="position:relative;">
              <th colspan="2" class="comp1-header right-align border-btm"
                :class="{'trace-border-left': currentOpenComp===idx, 'trace-border-top': currentOpenComp===idx, 'green-right-border': currentOpenComp===idx}"
                style="position:relative;">
                Comparable {{idx + 1}}
                <el-tooltip v-if="xaiType=='trace'" :content="currentOpenComp==idx ? 'Hide Trace' : 'Show Trace'"
                  placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <button class="toggle-button" @click="toggleCols(`comp${idx+1}`,idx)">

                    <span v-if="currentOpenComp!=idx" class="toggle-text">{{ currentOpenComp ==idx ? ' ' : '...'
                      }}</span>

                    <i class="toggle-text fa-solid fa-angle-left" v-if="currentOpenComp==idx"></i>

                  </button>
                </el-tooltip>
              </th>



            </template>
          </tr>
          <tr>
            <td class="comp1-header"></td>
            <td class="subject"></td>
            <template v-for="(row, idx) in LinearAdjustments[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <th style="width: 62px;" class="comp-header right-align border-btm"
                :class="{'trace-border-left': currentOpenComp===idx}">Values</th>
              <th :class="{'adj-price' : currentOpenComp===idx }"
                class="comp1-header right-align border-btm money highlight-green2" style="width: 62px;">
                <span> {{unit_list_header[domainIdx]}} Δ </span>
                <!-- <button class="toggle-button" @click="toggleCols(`comp${idx+1}`,idx)">
                  <span v-if="currentOpenComp!=idx" class="toggle-text">{{ currentOpenComp ==idx ? ' ' : '...' }}</span>
                  <i class="toggle-text fa-solid fa-angle-left" v-if="currentOpenComp==idx"></i>
                </button> -->
              </th>

            </template>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(tb, index) in Features[domainIdx]">
            <td class="feature-name">
              <span>{{ Features[domainIdx][index] }}</span>
              <el-tooltip :content="FeatureDescriptions[domainIdx]?.[index] || '' " placement="right" effect="dark"
                :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">
              <el-tooltip :content="Targets[domainIdx]?.[currentTargetIndex].feature_val[index] || '' "
                placement="right" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <div style=" display: inline-block;
                max-width: 62px;
                width: 62px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                vertical-align: top; cursor: pointer;">
                  {{ Targets[domainIdx]?.[currentTargetIndex].feature_val[index] || '' }}

                </div>
              </el-tooltip>

            </td>
            <template v-for="(row, idx) in LinearAdjustments[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align"
                :class="{'gray-font': row.delta_x[index]==0, 'trace-border-left': currentOpenComp===idx}">
                <el-tooltip :content="row.feature_val[index]" placement="right" effect="dark" :show-after="0"
                  trigger="hover" :hide-after="0">
                  <div style=" display: inline-block;
                  max-width: 62px;
                  width: 62px;
                  overflow: hidden;
                  white-space: nowrap;
                  text-overflow: ellipsis;
                  vertical-align: top; cursor: pointer;">
                    {{ row.feature_val[index] }}

                  </div>
                </el-tooltip>

              </td>
              <td style="cursor: pointer;" class="comp1-header right-align money highlight-green2"
                :class="{'gray-font': row.delta_x[index]==0, 'adj-price' : currentOpenComp==idx }">
                <el-tooltip :content="getDeltayTooltip(row,index)" placement="top" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  {{row.delta_y[index]!==0? row.delta_y[index]+unit_list[domainIdx]:'0' }}
                </el-tooltip>
                
              </td>

            </template>
          </tr>

          <tr class="">
            <td class="feature-name money highlight-green">{{Labels[domainIdx]?.[0] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark" :show-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject money highlight-green" @mouseenter="highlightAllAdjustedPrices()"
              @mouseleave="unhighlightAllAdjustedPrices()">
              <div style="cursor: pointer;">

                <el-tooltip placement="top" effect="light" :show-after="0" trigger="hover" :hide-after="0">
                  <template #content>
                    <span>Reconciled price (from adjusted comparables): {{weightedAverageValueLinearAdjustments}}{{unit_list[domainIdx]}} </span><br />
                    
                  
                    {{weightedAverageTooltipContentLinearAdjustments}}
                    <br />
                    <span style="color: #bd3030;">
                      Estimation error: {{getEstimationDifference(weightedAverageValueLinearAdjustments, Targets[domainIdx][currentTargetIndex].actual)}}
                    </span>
                  </template>
                  <span style="cursor: pointer;">
                
                    <u>Answer: {{Targets[domainIdx][currentTargetIndex].actual}}{{unit_list[domainIdx]}}</u>


                  </span>
                </el-tooltip>

                </span>
              </div>
            </td>
            <template v-for="(row, idx) in LinearAdjustments[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money highlight-green"
                :class="{ 'actual-price-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted, 'trace-border-left': currentOpenComp===idx }">
                <span>
                  {{row.actual}}{{unit_list[domainIdx]}}
              </td>
              <!-- {{row.actual}}{{unit_list[domainIdx]}} -->
              </td>

            </template>
          </tr>
          <tr>
            <td class="feature-name money border-top highlight-green2 ">{{Labels[domainIdx]?.[2] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][2]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align money subject highlight-green2 border-top">—</td>
            <template v-for="(row, idx) in LinearAdjustments[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money border-top highlight-green2"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted, 'trace-border-bottom': currentOpenComp===idx, 'trace-border-left': currentOpenComp===idx}"
                style="position:relative;">
                <span>{{row.adjusted_price}}{{unit_list[domainIdx]}}
              </td>

            </template>
          </tr>
          <!--  Reconsolidation -->

          <tr v-if="Comparables[domainIdx]?.[currentTargetIndex]?.length>1">
            <td class="feature-name">Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">—</td>
            <template v-for="(row, idx) in LinearAdjustments[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align"
                :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}" style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>

            </template>
          </tr>
          <tr>
            <td style="height:20px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>

            </template>
          </tr>

          <tr>
            <td class="feature-name money ai-pred-bg">{{Labels[domainIdx]?.[1] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>

              </span>
            </td>
            <td class="right-align money subject ai-pred-bg">
              {{Targets[domainIdx]?.[currentTargetIndex].pred}}{{unit_list[domainIdx]}} <br />
              <span class="pred-description"> {{getEstimationDifference(Targets[domainIdx]?.[currentTargetIndex].pred,Targets[domainIdx]?.[currentTargetIndex].actual)}} </span>
            </td>

            <template v-for="(row, idx) in LinearAdjustments[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money ai-pred-bg"
                :class="{ 'pred-highlight': highlightedActualPrice === idx, 'all-pred-actual-highlight': allPredAndActualHighlighted }">
                <span>
                  {{row.pred}}{{unit_list[domainIdx]}}
                  <br />
                  <el-tooltip
                    :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                    placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                    <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                      @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                  </el-tooltip>

              </td>

              </td>
            </template>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="tab-content" v-if="xaiType == 'linear_reg'" class="tab-content">
      <table class="plain-xai-table">
        <thead>
          <tr>
            <th></th>
            <th class="subject right-align border-btm" style="width: 62px;">Subject</th>
            <template v-for="(row, idx) in Comparables[domainIdx][currentTargetIndex]" :key="row.id">
              <th style="width: 62px;" class="right-align border-btm">Comparable {{idx+1}}</th>
            </template>

          </tr>

        </thead>
        <tbody>
          <template v-for="(feature, index) in Features[domainIdx]">
            <tr>
              <td class="feature-name">
                {{feature}}
                <el-tooltip :content="FeatureDescriptions[domainIdx]?.[index] || ''" placement="right" effect="dark"
                  :show-after="0">
                  <span class="tooltip-icon" style="cursor: pointer; margin-left: 4px;">
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </td>
              <td class="right-align">{{Targets[domainIdx]?.[currentTargetIndex].feature_val[index]}}</td>
              <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
                <td class="right-align" :style="{ color: row.feature_val[index] ==
                Targets[domainIdx]?.[currentTargetIndex].feature_val[index] ? '#ccc' : '#222' }">{{row.feature_val[index]}}</td>
              </template>
            </tr>

          </template>
          <tr>
            <td style="width: 140px;" class="feature-name money highlight-green">{{Labels[domainIdx]?.[0] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][0]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>

            <td class="right-align money highlight-green" style="cursor: pointer;">
              <el-tooltip placement="right" effect="light" :show-after="0">
                <template #content>
                  <!-- 1. 描述文字 -->
                  <div style="font-size:12px; font-weight:500; margin:10px 0;">
                  
                    Based on Comparables, the adjustment factors for each attribute are:
                    {{ Linear_reg[domainIdx]?.[currentTargetIndex]?.linear_pred.toFixed(1) }}{{ unit_list[domainIdx] }}
                    <br />
                    <span style="width:60px;color:#bd3030; font-size:12px; font-weight:400; line-height:12px;">
                      <!-- {{warningContent}} -->
                      Estimation error: {{getEstimationDifference(Linear_reg[domainIdx]?.[currentTargetIndex]?.linear_pred.toFixed(1), Targets[domainIdx][currentTargetIndex].actual)}}
                    </span>
                  </div>
                  <div style="display: flex;">
                    <!-- 2. 系数表格 -->
                    <table style="border-collapse: collapse; font-size: 12px; width:100%; margin-left:30px;">
                      <thead>
                        <tr>
                          <th style="padding:2px 0px; font-size: 12px; text-align:left;">Attribute</th>
                          <th style="padding:2px 0px; font-size: 12px; text-align:right;">Value</th>
                          <th style="padding:2px 0px; font-size: 12px; text-align:right;">Factors</th>
                          <th style="width:80px;padding:2px 0px; font-size: 12px; text-align:right; color:#2e8113">Partial ({{unit_list_header[domainIdx]}})</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr v-for="(row,i) in getLinearTooltipRows(domainIdx, currentTargetIndex)" :key="i" :style="{ color: row.factor ==
                        0 ? '#ddd' : '#222' }">
                          <td style="padding:0; height:16px;"><span
                              style="overflow: hidden; display:inline-block;width:100px; text-overflow:ellipsis;">{{
                              row.name }}</span></td>
                          <td style="padding:0; text-align:right;">{{ row.value }}</td>
                          <td style="padding:0 4px;text-align:right;">× <span
                              style="display:inline-block; width: 40px;">{{ row.factor ==0? '': row.factor }} </span>
                          </td>
                          <td style="padding:0 4px;text-align:right;">= 
                            <span
                              style="display:inline-block; width: 40px; color:#2e8113" :style="{color: row.factor ==0 ? '#ddd' : '#2e8113'}">
                              {{ row.factor ==0? '0': row.partial +  unit_list[domainIdx] }}</span>
                            </td>
                        </tr>

                        <tr style="font-weight:bold; color:#222; color:#2e8113">
                          <td colspan="3" style="padding:0px;">Default Value ({{unit_list_header[domainIdx]}})</td>
                       
                          <td style="padding:0px 4px; text-align:right;">= <span
                              style="display:inline-block; width: 40px;">
                              {{
                              Linear_reg[domainIdx][currentTargetIndex].intercept.toFixed(1) }}{{unit_list[domainIdx]}}
                            </span></td>
                        </tr>
                      
                      </tbody>
                    </table>
                    <!-- 3. 加号与箭头指向 AI Explainer -->
                    <div style="display:flex; align-items:center;">
                      <div style=" font-size:20px; margin-top:-4px; margin-left:10px; color:#2e8113"> } </div>
                      <div style="font-size:20px; margin-left:8px; color:#2e8113">+</div>
                      <div style="margin:0 8px; margin-top:-2px;font-size:14px; color:#2e8113">→</div>
                      <div style="width:60px; font-size:14px; color:#2e8113;">
                        {{unit_list_header[domainIdx]}}{{ Linear_reg[domainIdx][currentTargetIndex].linear_pred.toFixed(1) }}{{ unit_list[domainIdx] }}
                        <br />
                      </div>

                    </div>
                  </div>

                </template>
                <span class="right-align money highlight-green" style="cursor: pointer; font-weight:500;">
                  
                  <u>Answer: {{Targets[domainIdx][currentTargetIndex].actual}}{{unit_list[domainIdx]}}</u>
                </span>
              </el-tooltip>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="right-align money highlight-green">{{row.actual}}{{unit_list[domainIdx]}}</td>

            </template>
          </tr>

          <tr v-if="Comparables[domainIdx]?.[currentTargetIndex]?.length>1">
            <td class="feature-name">Similarity Score
              <el-tooltip content="The similarity score between the comparable and the subject." placement="right"
                effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
            </td>
            <td class="right-align subject">—</td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="comp1-header right-align" :class="{ 'adjusted-price-highlight': allAdjustedPricesHighlighted}"
                style="position:relative;">
                <span>{{ similarityScores[idx] }}%
              </td>
              <!-- <template v-for="(ele, i) in row.adjusted_price">
                <td :colspan="2" class="right-align comp-details" :class="{hidden: currentOpenComp!==idx}"
                  style="position:relative;">
                  <span></span>
                </td>
              </template> -->
            </template>
          </tr>

          <tr>
            <td style="height:8px;" class="feature-name money">
            </td>
            <td class="right-align money subject">
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td colspan="2" class="comp1-header right-align money"><span>

              </td>
              <td :colspan="row.adjusted_step_number*2" class="right-align" :class="{hidden: currentOpenComp!==idx}">

              </td>
            </template>
          </tr>



          <tr>
            <td style="width: 140px;" class="feature-name money">{{Labels[domainIdx]?.[1] || ''}}
              <el-tooltip :content="Labels_Descriptions[domainIdx][1]" placement="right" effect="dark" :show-after="0"
                trigger="hover" :hide-after="0">
                <span class="tooltip-icon">
                  <i class="fa-regular fa-circle-question"></i>
                </span>
              </el-tooltip>
              <el-tooltip content="Warning: the Decision Tool may be wrong, so consider this value carefully."
                placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                <span class="pred-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
              </el-tooltip>
              <br />
              <span class="pred-description" @mouseenter="highlightAllPredAndActual()"
                @mouseleave="unhighlightAllPredAndActual()">Prediction Error
                <el-tooltip content="The difference between the actual value and the predicted value." placement="right"
                  effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="tooltip-icon">
                    <!-- <i class="fa-regular fa-circle-question"></i> -->
                    <i class="fa-regular fa-circle-question"></i>
                  </span>
                </el-tooltip>
              </span>
            </td>

            <td class="right-align money">{{Targets[domainIdx]?.[currentTargetIndex].pred}}{{unit_list[domainIdx]}}
              <br> <span style="color: #bd3030;">
                {{getEstimationDifference(Targets[domainIdx]?.[currentTargetIndex].pred, Targets[domainIdx]?.[currentTargetIndex].actual)}}
              </span>
            </td>
            <template v-for="(row, idx) in Comparables[domainIdx]?.[currentTargetIndex]" :key="row.id">
              <td class="right-align money">{{row.pred}}{{unit_list[domainIdx]}}
                <br />
                <el-tooltip
                  :content="row.pred + unit_list[domainIdx] + ' is ' + getPredictionDifference(row) + ' than the actual value of ' + row.actual + unit_list[domainIdx]"
                  placement="bottom" effect="dark" :show-after="0" trigger="hover" :hide-after="0">
                  <span class="pred-description highlight-green" @mouseenter="highlightActualPrice(idx)"
                    @mouseleave="unhighlightActualPrice(idx)">{{ getPredictionDifference(row) }}</span>
                </el-tooltip>
              </td>
            </template>

          </tr>

        </tbody>
      </table>
    </div>
    <div v-if="internalTesting"
      style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; width: 300px;">
      <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" @click="toggleAnswer">
        <span style="font-weight: 500; color: #495057;">Check the Answer <span
            style="font-size: 12px; color: #6c757d;">(For internal testing)</span></span>
        <i :class="showAnswer ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'" style="color: #6c757d;"></i>
      </div>
      <div v-if="showAnswer"
        style="margin-top: 10px; padding: 10px; background: #e4fcdc; border-radius: 4px; border-left: 4px solid #28a745;">
        <span style="font-weight: 500; color: #155724;">Subject Actual Value: </span>
        <span class="money" style="font-size: 16px; font-weight: bold;">{{ subjectActualValue }}{{ subjectActualValue
          !== '-' ? 'K' : '' }}</span>
      </div>
    </div>

  </div>

  <script>

    // parse query params
    function getParam(key, defaultValue) {
      const params = new URLSearchParams(window.location.search);
      return params.has(key) ? params.get(key) : defaultValue;
    }
    const domainKeyToIndex = { house: 0, energy: 1, salary: 2 };
    const initDomain = getParam('domain', 'house');
    const initInstance = Number(getParam('instanceId', 0));
    const initXAItype = getParam('xaiType', 'noXAI');
    const initTesing = getParam('testing', false)


    const { createApp } = Vue;
    const { ElTooltip } = ElementPlus;

    createApp({
      components: {
        ElTooltip
      },
      data() {
        return {
          domain: initDomain,
          currentTargetIndex: initInstance,
          internalTesting: initTesing,
          xaiType: initXAItype,
          //about domain
          domain_list: [],
          unit_list: [],
          unit_list_header: [],
          warning: [],
          Labels: [
            //domain 1
            [],
            //domain 2
            [],
            //domain 3
            []
          ],
          Labels_Descriptions: [
            //domain 1
            [],
            // domain 2
            [],
            //domain 3
            []],
          numberical_feature: [
            //domain 1
            [],
            //domain 2
            [],
            //domain 3
            []
          ],
          Linear_reg: [],
          Features: [],
          FeatureDescriptions: [],
          Targets: [],
          Comparables: [],
          LinearAdjustments: [],
          categoryMappings: {},



          currentOpenComp: null,
          // Slider data
          slider_min: 200,
          slider_max: 500,
          minSliderValue: 350,
          maxSliderValue: 450,
          draggingHandle: null,
          isDragging: false,
          highlightedActualPrice: null,
          allAdjustedPricesHighlighted: false,
          allPredAndActualHighlighted: false,
          showAnswer: false,
          slider_ranges: [
            { min: 200, max: 500 }, // domain 0
            { min: 30, max: 200 }   // domain 1
          ],



        }
      },
      computed: {
        domainIdx() {
          return domainKeyToIndex[this.domain];
        },
        warningContent() {
          const msg = this.warning[this.domainIdx];
          return msg || 'Warning: estimate may be inaccurate.';
        },

        weightedAverageTooltipContent() {
          const comparables = this.Comparables[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.Comparables[this.domainIdx]) || comparables.length === 0) return '';

          let formula = '';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].adjusted_price && comparables[idx].adjusted_price.length > 0
              ? comparables[idx].adjusted_price[comparables[idx].adjusted_step_number - 1]
              : 0;
            formula += `${weight}% × ${price}${this.unit_list[this.domainIdx]}`;

            if (idx < comparables.length - 1) formula += ' + ';
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return formula;
          const avg = (sum / totalWeight).toFixed(1);
          return `${avg}${this.unit_list[this.domainIdx]} = ${formula}`;
        },
        weightedAverageValue() {
          const comparables = this.Comparables[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.Comparables[this.domainIdx]) || comparables.length === 0) return '-';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].adjusted_price && comparables[idx].adjusted_price.length > 0
              ? comparables[idx].adjusted_price[comparables[idx].adjusted_step_number - 1]
              : 0;
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return '-';
          return (sum / totalWeight).toFixed(1);
        },
        weightedAverageTooltipContentLinearAdjustments() {
          const comparables = this.LinearAdjustments[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.LinearAdjustments[this.domainIdx]) || comparables.length === 0) return '';

          let formula = '';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].adjusted_price
            formula += `${weight}% × ${price}${this.unit_list[this.domainIdx]}`;

            if (idx < comparables.length - 1) formula += ' + ';
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return formula;
          const avg = (sum / totalWeight).toFixed(1);
          return `${avg}${this.unit_list[this.domainIdx]} = ${formula}`;
        },
        weightedAverageValueLinearAdjustments() {
          const comparables = this.LinearAdjustments[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.LinearAdjustments[this.domainIdx]) || comparables.length === 0) return '-';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].adjusted_price
            console.log("comparables[idx].adjusted_price")
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return '-';
          return (sum / totalWeight).toFixed(1);
        },
        // for plain example based
        weightedAverageTooltipContentForComparable() {
          const comparables = this.Comparables[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.Comparables[this.domainIdx]) || comparables.length === 0) return '';

          let formula = '';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].actual
            formula += `${weight}% × ${price}${this.unit_list[this.domainIdx]}`;

            if (idx < comparables.length - 1) formula += ' + ';
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return formula;
          const avg = (sum / totalWeight).toFixed(1);
          return `${avg}${this.unit_list[this.domainIdx]} = ${formula}`;
        },
        weightedAverageValueForComparable() {
          const comparables = this.Comparables[this.domainIdx]?.[this.currentTargetIndex];
          if (!Array.isArray(this.Comparables[this.domainIdx]) || comparables.length === 0) return '-';
          let sum = 0;
          let totalWeight = 0;
          for (let idx = 0; idx < comparables.length; idx++) {
            const weight = this.similarityScores[idx] || 0;
            const price = comparables[idx].actual
            sum += weight * price;
            totalWeight += weight;
          }
          if (totalWeight === 0) return '-';
          return (sum / totalWeight).toFixed(1);
        },
        similarityScores() {
          const targets = this.Targets[this.domainIdx];
          const comparables = this.Comparables[this.domainIdx][this.currentTargetIndex];

          if (!Array.isArray(targets) || !targets[this.currentTargetIndex] || !Array.isArray(comparables)) {
            return [];
          }
          const subject = targets[this.currentTargetIndex];

          const scores = comparables.map(comp => {
            let score = 0;
            for (let i = 0; i < comp.feature_val.length; i++) {
              const subjVal = subject.feature_val[i];
              const compVal = comp.feature_val[i];
              if (this.numberical_feature[this.domainIdx][i]) {
                // 只在都能转成数字时才加分
                const subjNum = Number(subjVal);
                const compNum = Number(compVal);
                if (!isNaN(subjNum) && !isNaN(compNum)) {
                  const diff = Math.abs(subjNum - compNum);
                  score += 1 / (1 + diff);
                }
                // 否则不给分
              } else {
                // Categorical: 1 if equal, 0 if not
                score += subjVal === compVal ? 1 : 0;
              }
            }
            return score;
          });

          const total = scores.reduce((a, b) => a + b, 0);
          return scores.map(s => total ? Math.round((s / total) * 100) : 0);
        },
        currentSliderRange() {
          return this.slider_ranges[this.domainIdx];
        },
        minSliderPercent() {
          const range = this.currentSliderRange;
          return ((this.minSliderValue - range.min) / (range.max - range.min)) * 100;
        },
        maxSliderPercent() {
          const range = this.currentSliderRange;
          return ((this.maxSliderValue - range.min) / (range.max - range.min)) * 100;
        },
        currentComparableFinalPrices() {

          if (!Array.isArray(!this.Comparables[this.domainIdx]) || comparables.length === 0) return [];
          const comparables = this.Comparables[this.domainIdx][this.currentTargetIndex];

          const finalPrices = [];
          comparables.forEach(comp => {
            if (comp.final_adjusted_price) {
              finalPrices.push(comp.final_adjusted_price);
            }
          });

          return finalPrices;
        },
        comparablePriceRange() {
          const prices = this.currentComparableFinalPrices;
          if (prices.length === 0) return { min: 350, max: 450 };

          const min = Math.min(...prices);
          const max = Math.max(...prices);
          return { min, max };
        },
        subjectActualValue() {
          const target = this.Targets[this.domainIdx][this.currentTargetIndex];
          return target && target.actual ? target.actual : '-';
        }
      },
      async mounted() {
        const [map1, map2] = await Promise.all([
          fetch('./data/domain1.json').then(r => r.json()),
          fetch('./data/domain2.json').then(r => r.json())
        ]);
        this.categoryMappings = {
          "1": map1,
          "2": map2
        }
        this.loadCSVData()



      },
      watch: {
        domain() {
          this.currentTargetIndex = 0;

          this.showAnswer = false;
        },
        currentTargetIndex() {

          this.showAnswer = false;
        }
      },
      methods: {
        getDeltayTooltip(row,index){
          const featureName = this.Features[this.domainIdx][index];
          const featureVal = row.feature_val[index];
          const targetVal = this.Targets[this.domainIdx]?.[this.currentTargetIndex].feature_val[index];
          const deltaY = row.delta_y[index];
          if(deltaY ==0){
            return 'This attribute is same as the Subject, no adjustment needed'
          }
          const val = Number(deltaY)>0? '+'+ deltaY :deltaY 
          return `Change ${featureName} from ${featureVal} to ${targetVal} will adjust ${val}${this.unit_list[this.domainIdx]}`;
        },
        async loadCSV(filename) {
          return new Promise((resolve, reject) => {
            Papa.parse(filename, {
              download: true,
              header: true,
              dynamicTyping: true,
              skipEmptyLines: true,
              complete: (results) => {
                resolve(results.data);
              },
              error: (error) => {
                reject(error);
              }
            });
          });
        },
        // CSV data loading methods
        async loadCSVData() {
          try {
            // load all CSV files
            const [domainMetadata, metadata, subjects, comparables, linear_reg, linear_adjustments] = await Promise.all([
              this.loadCSV('./data/domain_metadata.csv'),
              this.loadCSV('./data/metadata.csv'),
              this.loadCSV('./data/practice/subject.csv'),
              this.loadCSV('./data/practice/comparables.csv'),
              this.loadCSV('./data/practice/linear_reg.csv'),
              this.loadCSV('./data/practice/linear_adjustments.csv')
            ]);
            console.log('loaded');

            // Process domain metadata
            this.processDomainMetadata(domainMetadata);

            // Process feature metadata
            this.processFeatureMetadata(metadata);
            // Process subjects (Targets)
            this.processSubjects(subjects);
            // Process comparables
            this.processComparables(comparables);
            this.processLinearReg(linear_reg);
            this.processLinearAdjustments(linear_adjustments);


          } catch (error) {
            console.error('Error loading CSV data:', error);
          }

        },
        processDomainMetadata(data) {
          // Initialize arrays with correct size
          const domainCount = Math.max(...data.map(row => row.domainId)) + 1;

          this.domain_list = new Array(domainCount);
          this.unit_list = new Array(domainCount);
          this.unit_list_header = new Array(domainCount);
          this.warning = new Array(domainCount);
          this.Labels = new Array(domainCount).fill(null).map(() => []);
          this.Labels_Descriptions = new Array(domainCount).fill(null).map(() => []);

          data.forEach(row => {
            const idx = row.domainId;
            this.domain_list[idx] = row.domainName;
            this.unit_list[idx] = row.unit;

            this.unit_list_header[idx] = row.unitHeader;
            this.warning[idx] = row.warning;
            this.Labels[idx] = [row.labelActual, row.labelPrediction, row.labelAdjusted];
            this.Labels_Descriptions[idx] = [row.descriptionActual, row.descriptionPrediction, row.descriptionAdjusted];
          });
          console.log("finished process domain metadata")
        },
        processFeatureMetadata(data) {
          // Group by domainId
          const grouped = {};
          data.forEach(row => {
            if (!grouped[row.domainId]) {
              grouped[row.domainId] = [];
            }
            grouped[row.domainId].push(row);
          });

          // Initialize arrays
          const domainCount = Math.max(...Object.keys(grouped).map(Number)) + 1;
          this.Features = new Array(domainCount).fill(null).map(() => []);
          this.FeatureDescriptions = new Array(domainCount).fill(null).map(() => []);
          this.numberical_feature = new Array(domainCount).fill(null).map(() => []);

          // Fill arrays
          Object.keys(grouped).forEach(domainId => {
            const domainIdx = Number(domainId);
            const features = grouped[domainId].sort((a, b) => a.featureId - b.featureId);

            this.Features[domainIdx] = features.map(f => f.featureName);
            this.FeatureDescriptions[domainIdx] = features.map(f => f.featureDescription);
            this.numberical_feature[domainIdx] = features.map(f => f.isNumerical);

          });
          console.log("finished process feature metadata")
        },
        processSubjects(data) {
          // Group by domainId and instanceId
          const grouped = {};
          data.forEach(row => {
            if (!grouped[row.domainId]) {
              grouped[row.domainId] = {};
            }
            const domainId = row.domainId;
            const numFlags = this.numberical_feature?.[domainId] || [];  // e.g. [true, false, ...]
            // Extract feature values
            const featureVals = extract_features(row, domainId, numFlags, this)

            grouped[row.domainId][row.instanceId] = {
              feature_val: featureVals,
              pred: row.pred,
              actual: row.actual
            };
          });

          // Convert to array format
          const domainCount = Math.max(...Object.keys(grouped).map(Number)) + 1;
          this.Targets = new Array(domainCount).fill(null).map(() => []);

          Object.keys(grouped).forEach(domainId => {
            const domainIdx = Number(domainId);
            const instances = grouped[domainId];
            const maxInstance = Math.max(...Object.keys(instances).map(Number));

            for (let i = 0; i <= maxInstance; i++) {
              this.Targets[domainIdx][i] = instances[i] || null;
            }
          });
          console.log("finished process subject")
        },
        processComparables(data) {

          // Group by domainId, instanceId, and comparableId
          const grouped = {};

          data.forEach(row => {
            if (!grouped[row.domainId]) {
              grouped[row.domainId] = {};
            }
            if (!grouped[row.domainId][row.instanceId]) {
              grouped[row.domainId][row.instanceId] = {};
            }
            const domainId = row.domainId;
            const numFlags = this.numberical_feature?.[domainId] || [];  // e.g. [true, false, ...]


            // Extract feature values and deltas

            const deltaX = [];
            const deltaY = [];
            const featureVals = extract_features(row, domainId, numFlags, this)
            for (let i = 0; i < 6; i++) {
              const val = row[`feature${i}`];

              const dx = row[`delta_x${i}`];
              const dy = row[`delta_y${i}`];

              const dxVal = Number(dx);
              const dyVal = Number(dy);
              deltaX.push(!isNaN(dxVal) ? dxVal.toFixed(1) : '0.0');
              deltaY.push(!isNaN(dyVal) ? dyVal.toFixed(1) : '0.0');
            }

            // Parse adjusted_order and adjusted_price arrays
            let adjustedOrder = [];
            let adjustedPrice = [];

            // Handle adjusted_order - could be string, array, or null
            if (row.adjusted_order) {
              if (typeof row.adjusted_order === 'string') {
                adjustedOrder = row.adjusted_order.split(',').map(Number);
              } else if (Array.isArray(row.adjusted_order)) {
                adjustedOrder = row.adjusted_order.map(Number);
              } else {
                adjustedOrder = [row.adjusted_order].map(Number);
              }
            }

            // Handle adjusted_price - could be string, array, or null
            if (row.adjusted_price) {
              if (typeof row.adjusted_price === 'string') {
                adjustedPrice = row.adjusted_price.split(',').map(Number);
              } else if (Array.isArray(row.adjusted_price)) {
                adjustedPrice = row.adjusted_price.map(Number);
              } else {
                adjustedPrice = [row.adjusted_price].map(Number);
              }
            }

            grouped[row.domainId][row.instanceId][row.comparableId] = {
              id: row.comparableId,
              feature_val: featureVals,
              delta_x: deltaX,
              delta_y: deltaY,
              pred: row.pred,
              actual: row.actual,
              adjusted_step_number: row.adjusted_step_number,
              adjusted_order: adjustedOrder,
              adjusted_price: adjustedPrice,
              final_adjusted_price: adjustedPrice[adjustedPrice.length - 1] || 0
            };
          });

          // Convert to array format
          const domainCount = Math.max(...Object.keys(grouped).map(Number)) + 1;
          this.Comparables = new Array(domainCount).fill(null).map(() => []);

          Object.keys(grouped).forEach(domainId => {
            const domainIdx = Number(domainId);
            const instances = grouped[domainId];

            Object.keys(instances).forEach(instanceId => {
              const instanceIdx = Number(instanceId);
              if (!this.Comparables[domainIdx][instanceIdx]) {
                this.Comparables[domainIdx][instanceIdx] = [];
              }

              const comparables = instances[instanceId];
              Object.keys(comparables).sort((a, b) => Number(a) - Number(b)).forEach(comparableId => {
                this.Comparables[domainIdx][instanceIdx].push(comparables[comparableId]);
              });
            });
          });

          // Ensure all instances have a Comparables array, even if empty
          for (let domainIdx = 0; domainIdx < this.Targets.length; domainIdx++) {
            const instances = this.Targets[domainIdx] || [];
            for (let instanceIdx = 0; instanceIdx < instances.length; instanceIdx++) {
              if (!this.Comparables[domainIdx]) {
                this.Comparables[domainIdx] = [];
              }
              if (!this.Comparables[domainIdx][instanceIdx]) {

                this.Comparables[domainIdx][instanceIdx] = [];
              }
            }
          }
        },
        processLinearReg(data) {
          const grouped = {};
          data.forEach(row => {
            const d = Number(row.domainId);
            const i = Number(row.instanceId);
            if (!grouped[d]) grouped[d] = {};
            // Collect intercept and coefficients
            const coefs = [
              Number(row.coef_0), Number(row.coef_1), Number(row.coef_2),
              Number(row.coef_3), Number(row.coef_4), Number(row.coef_5)
            ];
            const features_val = Array.from({ length: 6 }, (_, k) =>
              Number(row[`feature${k}`])
            );
            grouped[d][i] = {
              intercept: Number(row.intercept.toFixed(1)),
              coefs,
              features_val,
              linear_pred: Number(row.linear_pred.toFixed(1))
            };
          });

          // Prepare the Linear_reg array with correct dimensions
          const maxDomain = Math.max(...data.map(r => Number(r.domainId)));
          this.Linear_reg = Array.from({ length: maxDomain + 1 }, () => []);

          // Fill in the regression info, leaving gaps as null
          Object.entries(grouped).forEach(([domainKey, insts]) => {
            const d = Number(domainKey);
            const maxInst = Math.max(...Object.keys(insts).map(n => Number(n)));
            for (let idx = 0; idx <= maxInst; idx++) {
              this.Linear_reg[d][idx] = insts[idx] || null;
            }
          });
        },
        processLinearAdjustments(data) {
          // Group by domainId, instanceId, and comparableId
          const grouped = {};

          data.forEach(row => {
            if (!grouped[row.domainId]) {
              grouped[row.domainId] = {};
            }
            if (!grouped[row.domainId][row.instanceId]) {
              grouped[row.domainId][row.instanceId] = {};
            }
            const domainId = row.domainId;
            const numFlags = this.numberical_feature?.[domainId] || [];  // e.g. [true, false, ...]
            // Extract feature values and deltas
            const deltaX = [];
            const deltaY = [];
            const featureVals = extract_features(row, domainId, numFlags, this)
            for (let i = 0; i < 6; i++) {
              const val = row[`feature${i}`];

              const dx = row[`delta_x${i}`];
              const dy = row[`delta_y${i}`];

              const dxVal = Number(dx);
              const dyVal = Number(dy);
              deltaX.push(!isNaN(dxVal) ? dxVal.toFixed(1) : '0.0');
              deltaY.push(!isNaN(dyVal) ? dyVal.toFixed(1) : '0.0');
            }
            grouped[row.domainId][row.instanceId][row.comparableId] = {
              id: row.comparableId,
              feature_val: featureVals,
              delta_x: deltaX,
              delta_y: deltaY,
              pred: Number(row.pred).toFixed(1),
              actual: Number(row.actual).toFixed(1),
              adjusted_price: Number(row.adjusted_price).toFixed(1)
            };
          });

          // Convert to array format
          const domainCount = Math.max(...Object.keys(grouped).map(Number)) + 1;
          this.LinearAdjustments = new Array(domainCount).fill(null).map(() => []);

          Object.keys(grouped).forEach(domainId => {
            const domainIdx = Number(domainId);
            const instances = grouped[domainId];

            Object.keys(instances).forEach(instanceId => {
              const instanceIdx = Number(instanceId);
              if (!this.LinearAdjustments[domainIdx][instanceIdx]) {
                this.LinearAdjustments[domainIdx][instanceIdx] = [];
              }

              const comparables = instances[instanceId];
              Object.keys(comparables).sort((a, b) => Number(a) - Number(b)).forEach(comparableId => {
                this.LinearAdjustments[domainIdx][instanceIdx].push(comparables[comparableId]);
              });
            });
          });

          // Ensure all instances have a linear_adjustments array, even if empty
          for (let domainIdx = 0; domainIdx < this.Targets.length; domainIdx++) {
            const instances = this.Targets[domainIdx] || [];
            for (let instanceIdx = 0; instanceIdx < instances.length; instanceIdx++) {
              if (!this.LinearAdjustments[domainIdx]) {
                this.LinearAdjustments[domainIdx] = [];
              }
              if (!this.LinearAdjustments[domainIdx][instanceIdx]) {

                this.LinearAdjustments[domainIdx][instanceIdx] = [];
              }
            }
          }
         
        },
        // New helper: build rows for tooltip table
        getLinearTooltipRows(domainIdx, instanceIdx) {
          const lr = this.Linear_reg[domainIdx]?.[instanceIdx];
          const target = this.Targets[domainIdx]?.[instanceIdx];

          if (!lr || !target) return [];
          const names = this.Features[domainIdx] || [];
          const values = target.feature_val || [];
          const cal_values = lr.features_val || [];

          // Build each row: name, value, factor text, partial = coef * value
          return lr.coefs.map((coef, j) => {

            const name = names[j] || `x${j}`;
            const val = values[j];
            const factor = `${coef.toFixed(1)}`;
            const partial = (coef * Number(cal_values[j])).toFixed(1);
            return { name, value: val, factor, partial };
          });
        },
        computeLinearTooltip(domainIdx, instanceIdx) {
          const lr = this.Linear_reg[domainIdx]?.[instanceIdx];
          const target = this.Targets[domainIdx]?.[instanceIdx];
          if (!lr || !target) return '';
          const featureNames = this.Features[domainIdx] || [];
          const featureVals = target.feature_val || [];
          const terms = [String(lr.intercept.toFixed(1))];
          lr.coefs.forEach((coef, j) => {
            const fname = featureNames[j] ?? `x${j}`;
            const fval = featureVals[j] ?? '';
            if (coef != 0) {
              coef = coef.toFixed(1)
              terms.push(`${String(coef)}×${fname}(${String(fval)})`);
            }

          });
          const formula = terms.join(' + ');

          return `${formula} = ${String(lr.linear_pred.toFixed(1))}`;
        },
        highlightActualPrice(idx) {
          this.highlightedActualPrice = idx;
        },
        unhighlightActualPrice() {
          this.highlightedActualPrice = null;
        },
        highlightAllAdjustedPrices() {
          this.allAdjustedPricesHighlighted = true;
        },
        unhighlightAllAdjustedPrices() {
          this.allAdjustedPricesHighlighted = false;
        },
        highlightAllPredAndActual() {
          this.allPredAndActualHighlighted = true;
        },
        unhighlightAllPredAndActual() {
          this.allPredAndActualHighlighted = false;
        },
        toggleAnswer() {
          this.showAnswer = !this.showAnswer;
        },
        toggleCols(group, idx) {
          if (this.currentOpenComp == idx) {
            this.currentOpenComp = null
          } else {
            this.currentOpenComp = idx
          }

        },
        nextTarget() {
          if (this.currentTargetIndex < this.Targets[this.domainIdx].length - 1) {
            this.currentTargetIndex++;
            this.currentOpenComp = null;
          }
        },
        prevTarget() {
          if (this.currentTargetIndex > 0) {
            this.currentTargetIndex--;
            this.currentOpenComp = null;
          }
        },
        getPredictionDifference(row) {
          if (row.pred === 0 || row.actual === 0) {
            return "—";
          }

          const difference = row.pred - row.actual;
          const percentage = Math.abs((difference / row.actual) * 100);
          const roundedPercentage = Math.round(percentage * 10) / 10; // Round to 1 decimal place

          if (difference > 0) {
            return `${roundedPercentage}% Higher`;
          } else if (difference < 0) {
            return `${roundedPercentage}% Lower`;
          } else {
            return "0% (Same)";
          }
        },
        getEstimationDifference(pred, actual) {
          if (pred === 0 || actual === 0) {
            return "—";
          }

          const difference = pred - actual;
          const percentage = Math.abs((difference / actual) * 100);
          const roundedPercentage = Math.round(percentage * 10) / 10; // Round to 1 decimal place

          if (difference > 0) {
            return `${roundedPercentage}% Higher`;
          } else if (difference < 0) {
            return `${roundedPercentage}% Lower`;
          } else {
            return "0% (Same)";
          }
        },
        startHandleDrag(handle, event) {
          event.preventDefault();
          this.draggingHandle = handle;
          this.isDragging = true;
        },
        startSliderDrag(event) {
          if (!this.isDragging) {
            this.updateSliderValue(event);
          }
        },
        onSliderDrag(event) {
          if (this.isDragging) {
            this.updateSliderValue(event);
          }
        },
        stopSliderDrag() {
          this.isDragging = false;
          this.draggingHandle = null;
        },
        updateSliderValue(event) {
          const rect = event.currentTarget.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
          const range = this.currentSliderRange;
          const value = Math.round(range.min + (percent / 100) * (range.max - range.min));

          if (this.draggingHandle === 'min') {
            this.minSliderValue = Math.min(value, this.maxSliderValue - 10);
          } else if (this.draggingHandle === 'max') {
            this.maxSliderValue = Math.max(value, this.minSliderValue + 10);
          } else {
            // Click on track - move both handles
            const currentRange = this.maxSliderValue - this.minSliderValue;
            this.minSliderValue = Math.max(range.min, value - currentRange / 2);
            this.maxSliderValue = Math.min(range.max, this.minSliderValue + currentRange);
          }
        }
      }
    }).mount('#app');
  </script>

</body>

</html>